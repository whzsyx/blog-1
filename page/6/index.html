<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon.ico">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/blue/pace-theme-minimal.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Pisces',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":true},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Dunwu&#39;s Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Dunwu">
<meta property="og:url" content="https://dunwu.github.io/blog/page/6/index.html">
<meta property="og:site_name" content="Dunwu">
<meta property="og:description" content="Dunwu&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zhang Peng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://dunwu.github.io/blog/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Dunwu</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/blog/atom.xml" title="Dunwu" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Dunwu</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">大道至简，知易行难</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">102</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">37</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">173</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/dunwu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/2020/09/20/mongodb-%E5%A4%8D%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/09/20/mongodb-%E5%A4%8D%E5%88%B6/" class="post-title-link" itemprop="url">MongoDB 复制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-20 23:12:17" itemprop="dateCreated datePublished" datetime="2020-09-20T23:12:17+08:00">2020-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-14 16:45:53" itemprop="dateModified" datetime="2022-04-14T16:45:53+08:00">2022-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">文档数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2020/09/20/mongodb-%E5%A4%8D%E5%88%B6/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/09/20/mongodb-复制/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mongodb-复制"><a class="markdownIt-Anchor" href="#mongodb-复制"></a> MongoDB 复制</h1>
<h2 id="副本和可用性"><a class="markdownIt-Anchor" href="#副本和可用性"></a> 副本和可用性</h2>
<p>副本可以<strong>提供冗余并提高数据可用性</strong>。在不同数据库服务器上使用多个数据副本，可以提供一定程度的容错能力，以防止单个数据库服务器宕机时，数据丢失。</p>
<p>在某些情况下，副本还可以<strong>提供更大的读取吞吐量</strong>。因为客户端可以将读取操作发送到不同的服务器。在不同数据中心中维护数据副本可以提高数据本地性和分布式应用程序的可用性。您还可以维护其他副本以用于专用目的：例如灾难恢复，报告或备份。</p>
<h2 id="mongodb-副本"><a class="markdownIt-Anchor" href="#mongodb-副本"></a> MongoDB 副本</h2>
<p>MongoDB 中的副本集是一组维护相同数据集的 mongod 进程。一个副本集包含多个数据承载节点和一个仲裁器节点（可选）。在数据承载节点中，只有一个成员被视为主要节点，而其他节点则被视为次要节点。</p>
<p><strong>主节点负责接收所有写操作</strong>。副本集只能有一个主副本，能够以 <a href="https://docs.mongodb.com/manual/reference/write-concern/#writeconcern.%22majority%22" target="_blank" rel="noopener"><code>{ w: &quot;majority&quot; }</code></a> 来确认集群中节点的写操作成功情况；尽管在某些情况下，另一个 MongoDB 实例可能会暂时认为自己也是主要的。主节点在其操作日志（即 <a href="https://docs.mongodb.com/manual/core/replica-set-oplog/" target="_blank" rel="noopener">oplog</a>）中记录了对其数据集的所有更改。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920165054.svg" alt="img" /></p>
<p><strong>从节点复制主节点的操作日志，并将操作应用于其数据集</strong>，以便同步主节点的数据。如果主节点不可用，则符合条件的从节点将选举新的主节点。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920165055.svg" alt="img" /></p>
<p>在某些情况下（例如，有一个主节点和一个从节点，但由于成本限制，禁止添加另一个从节点），您可以选择将 mongod 实例作为仲裁节点添加到副本集。仲裁节点参加选举但不保存数据（即不提供数据冗余）。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920165053.svg" alt="img" /></p>
<p>仲裁节点将永远是仲裁节点。在选举期间，主节点可能会降级成为次节点，而次节点可能会升级成为主节点。</p>
<h2 id="异步复制"><a class="markdownIt-Anchor" href="#异步复制"></a> 异步复制</h2>
<h3 id="慢操作"><a class="markdownIt-Anchor" href="#慢操作"></a> 慢操作</h3>
<p>从节点复制主节点的操作日志，并将操作异步应用于其数据集。通过从节点同步主节点的数据集，即使一个或多个成员失败，副本集（MongoDB 集群）也可以继续运行。</p>
<p>从 4.2 版本开始，副本集的从节点记录慢操作（操作时间比设置的阈值长）的日志条目。这些慢操作在 <a href="https://docs.mongodb.com/manual/reference/log-messages/#REPL" target="_blank" rel="noopener"><code>REPL</code></a> 组件下的 <a href="https://docs.mongodb.com/manual/reference/program/mongod/#cmdoption-mongod-logpath" target="_blank" rel="noopener">诊断日志</a> 中记录了日志消息，并使用了文本 <code>op: &lt;oplog entry&gt;</code> 花费了 <code>&lt;num&gt;ms</code>。这些慢操作日志条目仅取决于慢操作阈值，而不取决于日志级别（在系统级别或组件级别），配置级别或运行缓慢的采样率。探查器不会捕获缓慢的操作日志条目。</p>
<h3 id="复制延迟和流控"><a class="markdownIt-Anchor" href="#复制延迟和流控"></a> 复制延迟和流控</h3>
<p>复制延迟（<a href="https://docs.mongodb.com/manual/reference/glossary/#term-replication-lag" target="_blank" rel="noopener">Replication lag</a>）是指将主节点上的写操作复制到从节点上所花费的时间。较短的延迟时间是可以接受的，但是随着复制延迟的增加，可能会出现严重的问题：比如在主节点上的缓存压力。</p>
<p>从 MongoDB 4.2 开始，管理员可以限制主节点的写入速率，使得大多数延迟时间保持在可配置的最大值 <a href="https://docs.mongodb.com/manual/reference/parameters/#param.flowControlTargetLagSeconds" target="_blank" rel="noopener"><code>flowControlTargetLagSeconds</code></a> 以下。</p>
<p>默认情况下，流控是开启的。</p>
<p>启用流控后，随着延迟时间越来越接近 <a href="https://docs.mongodb.com/manual/reference/parameters/#param.flowControlTargetLagSeconds" target="_blank" rel="noopener"><code>flowControlTargetLagSeconds</code></a>，主对象上的写操作必须先获得令牌，然后才能进行锁定并执行写操作。通过限制每秒发出的令牌数量，流控机制尝试将延迟保持在目标以下。</p>
<h2 id="故障转移"><a class="markdownIt-Anchor" href="#故障转移"></a> 故障转移</h2>
<p>当主节点与集群中的其他成员通信的时间超过配置的 <code>electionTimeoutMillis</code>（默认为 10 秒）时，符合选举要求的从节点将要求选举，并提名自己为新的主节点。集群尝试完成选举新主节点并恢复正常工作。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920175429.svg" alt="img" /></p>
<p>选举完成前，副本集无法处理写入操作。如果将副本集配置为：在主节点处于脱机状态时，在次节点上运行，则副本集可以继续提供读取查询。</p>
<p>假设<a href="https://docs.mongodb.com/manual/reference/replica-configuration/#rsconf.settings" target="_blank" rel="noopener">副本配置</a>采用默认配置，则集群选择新节点的时间通常不应超过 12 秒，这包括：将主节点标记为不可用并完成选举所需的时间。可以通过修改 <a href="https://docs.mongodb.com/manual/reference/replica-configuration/#rsconf.settings.electionTimeoutMillis" target="_blank" rel="noopener"><code>settings.electionTimeoutMillis</code></a> 配置选项来调整此时间。网络延迟等因素可能会延长完成选举所需的时间，进而影响集群在没有主节点的情况下可以运行的时间。这些因素取决于集群实际的情况。</p>
<p>将默认为 10 秒的 <a href="https://docs.mongodb.com/manual/reference/replica-configuration/#rsconf.settings.electionTimeoutMillis" target="_blank" rel="noopener"><code>electionTimeoutMillis</code></a> 选项数值缩小，可以更快地检测到主要故障。但是，由于网络延迟等因素，集群可能会更频繁地进行选举，即使该主节点实际上处于健康状态。这可能导致 <a href="https://docs.mongodb.com/manual/reference/write-concern/#wc-w" target="_blank" rel="noopener">w : 1</a> 写操作的回滚次数增加。</p>
<p>应用程序的连接逻辑应包括对自动故障转移和后续选举的容错处理。从 MongoDB 3.6 开始，MongoDB 驱动程序可以检测到主节点的失联，并可以自动重试一次某些写入操作。</p>
<p>从 MongoDB4.4 开始，MongoDB 提供镜像读取：将可选举的从节点的最近访问的数据，预热为缓存。预热从节点的缓存可以帮助在选举后更快地恢复。</p>
<h2 id="读操作"><a class="markdownIt-Anchor" href="#读操作"></a> 读操作</h2>
<h3 id="读优先"><a class="markdownIt-Anchor" href="#读优先"></a> 读优先</h3>
<p>默认情况下，客户端从主节点读取数据；但是，客户端可以指定读取首选项，以将读取操作发送到从节点。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920204024.svg" alt="img" /></p>
<p>异步复制到从节点意味着向从节点读取数据可能会返回与主节点不一致的数据。</p>
<p>包含读取操作的多文档事务必须使用读取主节点优先。给定事务中的所有操作必须路由到同一成员。</p>
<h3 id="数据可见性"><a class="markdownIt-Anchor" href="#数据可见性"></a> 数据可见性</h3>
<p>根据读取的关注点，客户端可以在持久化写入前查看写入结果：</p>
<ul>
<li>不管写的 <a href="https://docs.mongodb.com/manual/reference/write-concern/" target="_blank" rel="noopener">write concern</a> 如何设置，其他使用 <a href="https://docs.mongodb.com/manual/reference/read-concern-local/#readconcern.%22local%22" target="_blank" rel="noopener"><code>&quot;local&quot;</code></a> 或 <a href="https://docs.mongodb.com/manual/reference/read-concern-available/#readconcern.%22available%22" target="_blank" rel="noopener"><code>&quot;available&quot;</code></a> 的读配置的客户端都可以向发布客户端确认写操作之前看到写操作的结果。</li>
<li>使用 <a href="https://docs.mongodb.com/manual/reference/read-concern-local/#readconcern.%22local%22" target="_blank" rel="noopener"><code>&quot;local&quot;</code></a> 或 <a href="https://docs.mongodb.com/manual/reference/read-concern-available/#readconcern.%22available%22" target="_blank" rel="noopener"><code>&quot;available&quot;</code></a> 读取配置的客户端可以读取数据，这些数据随后可能会在副本集故障转移期间回滚。</li>
</ul>
<p>对于多文档事务中的操作，当事务提交时，在事务中进行的所有数据更改都将保存，并在事务外部可见。也就是说，事务在回滚其他事务时将不会提交其某些更改。在提交事务前，事务外部看不到在事务中进行的数据更改。</p>
<p>但是，当事务写入多个分片时，并非所有外部读操作都需要等待已提交事务的结果在所有分片上可见。例如，如果提交了一个事务，并且在分片 A 上可以看到写 1，但是在分片 B 上还看不到写 2，则在 <a href="https://docs.mongodb.com/manual/reference/read-concern-local/#readconcern.%22local%22" target="_blank" rel="noopener"><code>&quot;local&quot;</code></a> 读配置级别，外部读取可以读取写 1 的结果而看不到写 2。</p>
<h3 id="镜像读取"><a class="markdownIt-Anchor" href="#镜像读取"></a> 镜像读取</h3>
<p>从 MongoDB 4.4 开始，MongoDB 提供镜像读取以预热可选从节点（即优先级大于 0 的成员）的缓存。使用镜像读取（默认情况下已启用），主节点可以镜像它接收到的一部分操作，并将其发送给可选择的从节点的子集。子集的大小是可配置的。</p>
<h2 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h2>
<ul>
<li><strong>官方</strong>
<ul>
<li><a href="https://www.mongodb.com/" target="_blank" rel="noopener">MongoDB 官网</a></li>
<li><a href="https://github.com/mongodb/mongo" target="_blank" rel="noopener">MongoDB Github</a></li>
<li><a href="https://university.mongodb.com/" target="_blank" rel="noopener">MongoDB 官方免费教程</a></li>
</ul>
</li>
<li><strong>教程</strong>
<ul>
<li><a href="https://www.runoob.com/mongodb/mongodb-tutorial.html" target="_blank" rel="noopener">MongoDB 教程</a></li>
<li><a href="https://time.geekbang.org/course/intro/100040001" target="_blank" rel="noopener">MongoDB 高手课</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/2020/09/20/mongodb-%E5%88%86%E7%89%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/09/20/mongodb-%E5%88%86%E7%89%87/" class="post-title-link" itemprop="url">MongoDB 分片</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-20 23:12:17" itemprop="dateCreated datePublished" datetime="2020-09-20T23:12:17+08:00">2020-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-14 16:45:53" itemprop="dateModified" datetime="2022-04-14T16:45:53+08:00">2022-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">文档数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2020/09/20/mongodb-%E5%88%86%E7%89%87/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/09/20/mongodb-分片/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mongodb-分片"><a class="markdownIt-Anchor" href="#mongodb-分片"></a> MongoDB 分片</h1>
<h2 id="分片集群简介"><a class="markdownIt-Anchor" href="#分片集群简介"></a> 分片集群简介</h2>
<p>当 MongoDB 需要存储海量数据时，单节点不足以存储全量数据，且可能无法提供令人满意的吞吐量。所以，可以通过 MongoDB 分片机制来支持水平扩展。</p>
<h3 id="分片集群特点"><a class="markdownIt-Anchor" href="#分片集群特点"></a> 分片集群特点</h3>
<p>对应用完全透明</p>
<p>数据自动均衡</p>
<p>动态扩容</p>
<p>提供三种分片方式</p>
<h3 id="分片集群组件"><a class="markdownIt-Anchor" href="#分片集群组件"></a> 分片集群组件</h3>
<p>MongoDB 分片集群含以下组件：</p>
<ul>
<li><a href="https://docs.mongodb.com/manual/core/sharded-cluster-shards/" target="_blank" rel="noopener">shard</a>：每个分片包含分片数据的子集。每个分片都可以部署为副本集。</li>
<li><a href="https://docs.mongodb.com/manual/core/sharded-cluster-query-router/" target="_blank" rel="noopener">mongos</a>：mongos 充当查询路由器，在客户端应用程序和分片集群之间提供接口。从 MongoDB 4.4 开始，mongos 可以支持 <a href="https://docs.mongodb.com/manual/core/sharded-cluster-query-router/#mongos-hedged-reads" target="_blank" rel="noopener">hedged reads</a> 以最大程度地减少延迟。</li>
<li><a href="https://docs.mongodb.com/manual/core/sharded-cluster-config-servers/" target="_blank" rel="noopener">config servers</a>：提供集群元数据存储和分片数据分布的映射。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920210057.svg" alt="img" /></p>
<h3 id="分片集群的分布"><a class="markdownIt-Anchor" href="#分片集群的分布"></a> 分片集群的分布</h3>
<p><strong>MongoDB 复制集以 collection 为单位</strong>，将数据分布在集群中的各个分片上。最多允许 1024 个分片。</p>
<p>MongoDB 复制集的分片之间数据不重复，只有当所有分片都正常时，才能完整工作。</p>
<p>MongoDB 数据库可以同时包含分片和未分片的集合的 collection。分片 collection 会分布在集群中各节点上。而未分片的 collection 存储在主节点上。每个数据库都有其自己的主节点。</p>
<p>分片和未分片的 collection：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920212159.svg" alt="img" /></p>
<h3 id="路由节点-mongos"><a class="markdownIt-Anchor" href="#路由节点-mongos"></a> 路由节点 mongos</h3>
<p>要连接 <a href="https://docs.mongodb.com/manual/reference/glossary/#term-sharded-cluster" target="_blank" rel="noopener">MongoDB 分片集群</a>，必须连接到 <a href="https://docs.mongodb.com/manual/reference/glossary/#term-mongos" target="_blank" rel="noopener"><code>mongos</code></a> 路由器。这包括分片和未分片的 collection。客户端不应该连接到单个分片节点进行读写操作。</p>
<p>连接 <a href="https://docs.mongodb.com/manual/reference/program/mongos/#bin.mongos" target="_blank" rel="noopener"><code>mongos</code></a> 的方式和连接 <a href="https://docs.mongodb.com/manual/reference/program/mongod/#bin.mongod" target="_blank" rel="noopener"><code>mongod</code></a> 相同，例如通过 <a href="https://docs.mongodb.com/manual/reference/program/mongo/#bin.mongo" target="_blank" rel="noopener"><code>mongo</code></a> shell 或 <a href="https://docs.mongodb.com/drivers/?jump=docs" target="_blank" rel="noopener">MongoDB 驱动程序</a>。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920212157.svg" alt="img" /></p>
<p>路由节点的作用：</p>
<ul>
<li>提供集群的单一入口</li>
<li>转发应用端请求</li>
<li>选择合适数据节点进行读写</li>
<li>合并多个数据节点的返回</li>
</ul>
<p>一般，路由节点 mongos 建议至少 2 个。</p>
<h2 id="分片-key"><a class="markdownIt-Anchor" href="#分片-key"></a> 分片 Key</h2>
<p>MongoDB 使用分片 Key 在各个分片之间分发 collection 的 document。分片 Key 由 document 中的一个或多个字段组成。</p>
<ul>
<li>
<p>从 MongoDB 4.4 开始，分片 collection 中的 document 可能缺少分片 Key 字段。在跨分片分布文档时，缺少分片 Key 字段将被视为具有空值，但在路由查询时则不会。</p>
</li>
<li>
<p>在 MongoDB 4.2 及更早版本中，分片 Key 字段必须在每个 document 中存在一个分片 collection。</p>
</li>
</ul>
<p>在分片 collection 时选择分片 Key。</p>
<ul>
<li>从 MongoDB 4.4 开始，您可以通过在现有 Key 中添加一个或多个后缀字段来优化 collection 的分片 Key。</li>
<li>在 MongoDB 4.2 和更低版本中，无法在分片后更改分片 Key 的选择。</li>
</ul>
<p>document 的分片键值决定了其在各个分片中的分布</p>
<ul>
<li>从 MongoDB 4.2 开始，除非您的分片 Key 字段是不可变的_id 字段，否则您可以更新 document 的分片键值。</li>
<li>在 MongoDB 4.0 及更低版本中，文档的分片 Key 字段值是不可变的。</li>
</ul>
<p>分片 Key 索引：要对已填充的 collection 进行分片，该 collection 必须具有以分片 Key 开头的索引。分片一个空 collection 时，如果该 collection 还没有针对指定分片 Key 的适当索引，则 MongoDB 会创建支持索引。</p>
<p>分片 Key 策略：分片 Key 的选择会影响分片集群的性能，效率和可伸缩性。分片 Key 及其后备索引的选择也会影响集群可以使用的分片策略。</p>
<p>MongoDB 分区将数据分片。每个分块都有基于分片 Key 的上下限。</p>
<p>为了在整个集群中的所有分片上实现块的均匀分布，均衡器在后台运行，并在各分片上迁移块。</p>
<h2 id="分片策略"><a class="markdownIt-Anchor" href="#分片策略"></a> 分片策略</h2>
<p>MongoDB 支持两种分片策略：Hash 分片和范围分片。</p>
<h3 id="hash-分片"><a class="markdownIt-Anchor" href="#hash-分片"></a> Hash 分片</h3>
<p>Hash 分片策略会先计算分片 Key 字段值的哈希值；然后，根据分片键值为每个 <a href="https://docs.mongodb.com/manual/reference/glossary/#term-chunk" target="_blank" rel="noopener">chunk</a> 分配一个范围。</p>
<blockquote>
<p>注意：使用哈希索引解析查询时，MongoDB 会自动计算哈希值，应用程序不需要计算哈希。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920213343.svg" alt="img" /></p>
<p>尽管分片 Key 范围可能是“接近”的，但它们的哈希值不太可能在同一 <a href="https://docs.mongodb.com/manual/reference/glossary/#term-chunk" target="_blank" rel="noopener">chunk</a> 上。基于 Hash 的数据分发有助于更均匀的数据分布，尤其是在分片 Key 单调更改的数据集中。</p>
<p>但是，Hash 分片意味着对分片 Key 做范围查询时不太可能针对单个分片，从而导致更多的集群范围内的广播操作。</p>
<h3 id="范围分片"><a class="markdownIt-Anchor" href="#范围分片"></a> 范围分片</h3>
<p>范围分片根据分片 Key 值将数据划分为多个范围。然后，根据分片 Key 值为每个 <a href="https://docs.mongodb.com/manual/reference/glossary/#term-chunk" target="_blank" rel="noopener">chunk</a> 分配一个范围。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920213345.svg" alt="img" /></p>
<p>值比较近似的一系列分片 Key 更有可能驻留在同一 <a href="https://docs.mongodb.com/manual/reference/glossary/#term-chunk" target="_blank" rel="noopener">chunk</a> 上。范围分片的效率取决于选择的分片 Key。分片 Key 考虑不周全会导致数据分布不均，这可能会削弱分片的某些优势或导致性能瓶颈。</p>
<h2 id="分片集群中的区域"><a class="markdownIt-Anchor" href="#分片集群中的区域"></a> 分片集群中的区域</h2>
<p>区域可以提高跨多个数据中心的分片集群的数据局部性。</p>
<p>在分片集群中，可以基于分片 Key 创建分片数据<a href="https://docs.mongodb.com/manual/reference/glossary/#term-zone" target="_blank" rel="noopener">区域</a>。可以将每个区域与集群中的一个或多个分片关联。分片可以与任意数量的区域关联。在平衡的集群中，MongoDB 仅将区域覆盖的 <a href="https://docs.mongodb.com/manual/reference/glossary/#term-chunk" target="_blank" rel="noopener">chunk</a> 迁移到与该区域关联的分片。</p>
<p>每个区域覆盖一个或多个分片 Key 值范围。区域覆盖的每个范围始终包括其上下边界。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920214854.svg" alt="img" /></p>
<p>在定义要覆盖的区域的新范围时，必须使用分片 Key 中包含的字段。如果使用复合分片 Key，则范围必须包含分片 Key 的前缀。</p>
<p>选择分片 Key 时，应考虑将来可能使用的区域。</p>
<h2 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h2>
<ul>
<li><strong>官方</strong>
<ul>
<li><a href="https://www.mongodb.com/" target="_blank" rel="noopener">MongoDB 官网</a></li>
<li><a href="https://github.com/mongodb/mongo" target="_blank" rel="noopener">MongoDB Github</a></li>
<li><a href="https://university.mongodb.com/" target="_blank" rel="noopener">MongoDB 官方免费教程</a></li>
</ul>
</li>
<li><strong>教程</strong>
<ul>
<li><a href="https://www.runoob.com/mongodb/mongodb-tutorial.html" target="_blank" rel="noopener">MongoDB 教程</a></li>
<li><a href="https://time.geekbang.org/course/intro/100040001" target="_blank" rel="noopener">MongoDB 高手课</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/2020/09/12/mysql-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/09/12/mysql-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">Mysql 常见问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-12 10:43:53" itemprop="dateCreated datePublished" datetime="2020-09-12T10:43:53+08:00">2020-09-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-14 16:45:53" itemprop="dateModified" datetime="2022-04-14T16:45:53+08:00">2022-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">关系型数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/" itemprop="url" rel="index">
                    <span itemprop="name">Mysql</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2020/09/12/mysql-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/09/12/mysql-常见问题/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>688</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mysql-常见问题"><a class="markdownIt-Anchor" href="#mysql-常见问题"></a> Mysql 常见问题</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a href="https://github.com/dunwu/db-tutorial/" target="_blank" rel="noopener">db-tutorial</a></strong></p>
</blockquote>
<h2 id="1-为什么表数据删掉一半表文件大小不变"><a class="markdownIt-Anchor" href="#1-为什么表数据删掉一半表文件大小不变"></a> 1. 为什么表数据删掉一半，表文件大小不变</h2>
<p>【问题】数据库占用空间太大，我把一个最大的表删掉了一半的数据，怎么表文件的大小还是没变？</p>
<p>表数据既可以存在共享表空间里，也可以是单独的文件。这个行为是由参数 <code>innodb_file_per_table</code> 控制的：</p>
<ol>
<li>这个参数设置为 OFF 表示的是，表的数据放在系统共享表空间，也就是跟数据字典放在一起；</li>
<li>这个参数设置为 ON 表示的是，每个 InnoDB 表数据存储在一个以 .ibd 为后缀的文件中。</li>
</ol>
<p>从 MySQL 5.6.6 版本开始，它的默认值就是 ON 了。</p>
<p>我建议你不论使用 MySQL 的哪个版本，都将这个值设置为 ON。因为，一个表单独存储为一个文件更容易管理，而且在你不需要这个表的时候，通过 drop table 命令，系统就会直接删除这个文件。而如果是放在共享表空间中，即使表删掉了，空间也是不会回收的。</p>
<p>所以，<strong>将 innodb_file_per_table 设置为 ON，是推荐做法，我们接下来的讨论都是基于这个设置展开的。</strong></p>
<p>我们在删除整个表的时候，可以使用 drop table 命令回收表空间。但是，我们遇到的更多的删除数据的场景是删除某些行，这时就遇到了我们文章开头的问题：表中的数据被删除了，但是表空间却没有被回收。</p>
<p><strong>插入和删除操作可能会造成空洞</strong>。</p>
<ul>
<li>插入时，如果插入位置所在页已满，需要申请新页面。</li>
<li>删除时，不会删除所在页，而是将记录在页面的位置标记为可重用。</li>
</ul>
<p>所以，如果能够把这些空洞去掉，就能达到收缩表空间的目的。</p>
<p>要达到收缩空洞的目的，可以使用重建表的方式。</p>
<h2 id="2-参考资料"><a class="markdownIt-Anchor" href="#2-参考资料"></a> 2. 参考资料</h2>
<ul>
<li><a href="https://book.douban.com/subject/23008813/" target="_blank" rel="noopener">《高性能 MySQL》</a></li>
<li><a href="https://time.geekbang.org/column/intro/139" target="_blank" rel="noopener">MySQL 实战 45 讲</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/2020/09/12/mongodb-%E5%BB%BA%E6%A8%A1%E7%A4%BA%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/09/12/mongodb-%E5%BB%BA%E6%A8%A1%E7%A4%BA%E4%BE%8B/" class="post-title-link" itemprop="url">MongoDB 建模示例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-12 10:43:53" itemprop="dateCreated datePublished" datetime="2020-09-12T10:43:53+08:00">2020-09-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-14 16:45:53" itemprop="dateModified" datetime="2022-04-14T16:45:53+08:00">2022-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">文档数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2020/09/12/mongodb-%E5%BB%BA%E6%A8%A1%E7%A4%BA%E4%BE%8B/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/09/12/mongodb-建模示例/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>9.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>9 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mongodb-建模示例"><a class="markdownIt-Anchor" href="#mongodb-建模示例"></a> MongoDB 建模示例</h1>
<h2 id="关系型模型"><a class="markdownIt-Anchor" href="#关系型模型"></a> 关系型模型</h2>
<h3 id="嵌入式文档一对一关系模型"><a class="markdownIt-Anchor" href="#嵌入式文档一对一关系模型"></a> 嵌入式文档一对一关系模型</h3>
<h4 id="嵌入式文档一对一关系模型-嵌入式文档模式"><a class="markdownIt-Anchor" href="#嵌入式文档一对一关系模型-嵌入式文档模式"></a> 嵌入式文档一对一关系模型 - 嵌入式文档模式</h4>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="comment">// patron document</span></span><br><span class="line">&#123;</span><br><span class="line">   _id: "joe",</span><br><span class="line">   name: "Joe Bookreader"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// address document</span></span><br><span class="line">&#123;</span><br><span class="line">   patron_id: "joe", // reference to patron document</span><br><span class="line">   street: "123 Fake Street",</span><br><span class="line">   city: "Faketon",</span><br><span class="line">   state: "MA",</span><br><span class="line">   zip: "12345"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>合并为：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="string">"joe"</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"Joe Bookreader"</span>,</span><br><span class="line">  <span class="attr">"address"</span>: &#123;</span><br><span class="line">    <span class="attr">"street"</span>: <span class="string">"123 Fake Street"</span>,</span><br><span class="line">    <span class="attr">"city"</span>: <span class="string">"Faketon"</span>,</span><br><span class="line">    <span class="attr">"state"</span>: <span class="string">"MA"</span>,</span><br><span class="line">    <span class="attr">"zip"</span>: <span class="string">"12345"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="嵌入式文档一对一关系模型-子集模式"><a class="markdownIt-Anchor" href="#嵌入式文档一对一关系模型-子集模式"></a> 嵌入式文档一对一关系模型 - 子集模式</h4>
<p>假设，有一个用于描述电影信息的 collection 定义：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"The Arrival of a Train"</span>,</span><br><span class="line">  <span class="attr">"year"</span>: <span class="number">1896</span>,</span><br><span class="line">  <span class="attr">"runtime"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"released"</span>: ISODate(<span class="string">"01-25-1896"</span>),</span><br><span class="line">  <span class="attr">"poster"</span>: <span class="string">"http://ia.media-imdb.com/images/M/MV5BMjEyNDk5MDYzOV5BMl5BanBnXkFtZTgwNjIxMTEwMzE@._V1_SX300.jpg"</span>,</span><br><span class="line">  <span class="attr">"plot"</span>: <span class="string">"A group of people are standing in a straight line along the platform of a railway station, waiting for a train, which is seen coming at some distance. When the train stops at the platform, ..."</span>,</span><br><span class="line">  <span class="attr">"fullplot"</span>: <span class="string">"A group of people are standing in a straight line along the platform of a railway station, waiting for a train, which is seen coming at some distance. When the train stops at the platform, the line dissolves. The doors of the railway-cars open, and people on the platform help passengers to get off."</span>,</span><br><span class="line">  <span class="attr">"lastupdated"</span>: ISODate(<span class="string">"2015-08-15T10:06:53"</span>),</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"movie"</span>,</span><br><span class="line">  <span class="attr">"directors"</span>: [<span class="string">"Auguste Lumière"</span>, <span class="string">"Louis Lumière"</span>],</span><br><span class="line">  <span class="attr">"imdb"</span>: &#123;</span><br><span class="line">    <span class="attr">"rating"</span>: <span class="number">7.3</span>,</span><br><span class="line">    <span class="attr">"votes"</span>: <span class="number">5043</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">12</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"countries"</span>: [<span class="string">"France"</span>],</span><br><span class="line">  <span class="attr">"genres"</span>: [<span class="string">"Documentary"</span>, <span class="string">"Short"</span>],</span><br><span class="line">  <span class="attr">"tomatoes"</span>: &#123;</span><br><span class="line">    <span class="attr">"viewer"</span>: &#123;</span><br><span class="line">      <span class="attr">"rating"</span>: <span class="number">3.7</span>,</span><br><span class="line">      <span class="attr">"numReviews"</span>: <span class="number">59</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"lastUpdated"</span>: ISODate(<span class="string">"2020-01-09T00:02:53"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在应用中，有的场景只需要显示电影的简单浏览信息，不需要显示类似 fullplot、poster 这样的详细信息。因为，我们可以考虑将原结构一份为二，并通过 id 字段关联起来。</p>
<p>用于展示摘要信息的 movie collection</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">// movie collection</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"The Arrival of a Train"</span>,</span><br><span class="line">  <span class="attr">"year"</span>: <span class="number">1896</span>,</span><br><span class="line">  <span class="attr">"runtime"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"released"</span>: ISODate(<span class="string">"1896-01-25"</span>),</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"movie"</span>,</span><br><span class="line">  <span class="attr">"directors"</span>: [<span class="string">"Auguste Lumière"</span>, <span class="string">"Louis Lumière"</span>],</span><br><span class="line">  <span class="attr">"countries"</span>: [<span class="string">"France"</span>],</span><br><span class="line">  <span class="attr">"genres"</span>: [<span class="string">"Documentary"</span>, <span class="string">"Short"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用于展示细节信息的 movie_details collection</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">// movie_details collection</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="number">156</span>,</span><br><span class="line">  <span class="attr">"movie_id"</span>: <span class="number">1</span>, <span class="comment">// reference to the movie collection</span></span><br><span class="line">  <span class="attr">"poster"</span>: <span class="string">"http://ia.media-imdb.com/images/M/MV5BMjEyNDk5MDYzOV5BMl5BanBnXkFtZTgwNjIxMTEwMzE@._V1_SX300.jpg"</span>,</span><br><span class="line">  <span class="attr">"plot"</span>: <span class="string">"A group of people are standing in a straight line along the platform of a railway station, waiting for a train, which is seen coming at some distance. When the train stops at the platform, ..."</span>,</span><br><span class="line">  <span class="attr">"fullplot"</span>: <span class="string">"A group of people are standing in a straight line along the platform of a railway station, waiting for a train, which is seen coming at some distance. When the train stops at the platform, the line dissolves. The doors of the railway-cars open, and people on the platform help passengers to get off."</span>,</span><br><span class="line">  <span class="attr">"lastupdated"</span>: ISODate(<span class="string">"2015-08-15T10:06:53"</span>),</span><br><span class="line">  <span class="attr">"imdb"</span>: &#123;</span><br><span class="line">    <span class="attr">"rating"</span>: <span class="number">7.3</span>,</span><br><span class="line">    <span class="attr">"votes"</span>: <span class="number">5043</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">12</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"tomatoes"</span>: &#123;</span><br><span class="line">    <span class="attr">"viewer"</span>: &#123;</span><br><span class="line">      <span class="attr">"rating"</span>: <span class="number">3.7</span>,</span><br><span class="line">      <span class="attr">"numReviews"</span>: <span class="number">59</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"lastUpdated"</span>: ISODate(<span class="string">"2020-01-29T00:02:53"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="嵌入式文档一对多关系模型"><a class="markdownIt-Anchor" href="#嵌入式文档一对多关系模型"></a> 嵌入式文档一对多关系模型</h3>
<h4 id="嵌入式文档一对多关系模型-嵌入式文档模式"><a class="markdownIt-Anchor" href="#嵌入式文档一对多关系模型-嵌入式文档模式"></a> 嵌入式文档一对多关系模型 - 嵌入式文档模式</h4>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="comment">// patron document</span></span><br><span class="line">&#123;</span><br><span class="line">   _id: "joe",</span><br><span class="line">   name: "Joe Bookreader"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// address documents</span></span><br><span class="line">&#123;</span><br><span class="line">   patron_id: "joe", // reference to patron document</span><br><span class="line">   street: "123 Fake Street",</span><br><span class="line">   city: "Faketon",</span><br><span class="line">   state: "MA",</span><br><span class="line">   zip: "12345"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   patron_id: "joe",</span><br><span class="line">   street: "1 Some Other Street",</span><br><span class="line">   city: "Boston",</span><br><span class="line">   state: "MA",</span><br><span class="line">   zip: "12345"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>合并为：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="string">"joe"</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"Joe Bookreader"</span>,</span><br><span class="line">  <span class="attr">"addresses"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"street"</span>: <span class="string">"123 Fake Street"</span>,</span><br><span class="line">      <span class="attr">"city"</span>: <span class="string">"Faketon"</span>,</span><br><span class="line">      <span class="attr">"state"</span>: <span class="string">"MA"</span>,</span><br><span class="line">      <span class="attr">"zip"</span>: <span class="string">"12345"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"street"</span>: <span class="string">"1 Some Other Street"</span>,</span><br><span class="line">      <span class="attr">"city"</span>: <span class="string">"Boston"</span>,</span><br><span class="line">      <span class="attr">"state"</span>: <span class="string">"MA"</span>,</span><br><span class="line">      <span class="attr">"zip"</span>: <span class="string">"12345"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="嵌入式文档一对多关系模型-子集模式"><a class="markdownIt-Anchor" href="#嵌入式文档一对多关系模型-子集模式"></a> 嵌入式文档一对多关系模型 - 子集模式</h4>
<p>考虑一个电商网站用于表示商品的 collection：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"Super Widget"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"This is the most useful item in your toolbox."</span>,</span><br><span class="line">  <span class="attr">"price"</span>: &#123; <span class="attr">"value"</span>: NumberDecimal(<span class="string">"119.99"</span>), <span class="attr">"currency"</span>: <span class="string">"USD"</span> &#125;,</span><br><span class="line">  <span class="attr">"reviews"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"review_id"</span>: <span class="number">786</span>,</span><br><span class="line">      <span class="attr">"review_author"</span>: <span class="string">"Kristina"</span>,</span><br><span class="line">      <span class="attr">"review_text"</span>: <span class="string">"This is indeed an amazing widget."</span>,</span><br><span class="line">      <span class="attr">"published_date"</span>: ISODate(<span class="string">"2019-02-18"</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"review_id"</span>: <span class="number">785</span>,</span><br><span class="line">      <span class="attr">"review_author"</span>: <span class="string">"Trina"</span>,</span><br><span class="line">      <span class="attr">"review_text"</span>: <span class="string">"Nice product. Slow shipping."</span>,</span><br><span class="line">      <span class="attr">"published_date"</span>: ISODate(<span class="string">"2019-02-17"</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    ...&#123;</span><br><span class="line">      <span class="attr">"review_id"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"review_author"</span>: <span class="string">"Hans"</span>,</span><br><span class="line">      <span class="attr">"review_text"</span>: <span class="string">"Meh, it's okay."</span>,</span><br><span class="line">      <span class="attr">"published_date"</span>: ISODate(<span class="string">"2017-12-06"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>评论按时间倒序排列。 当用户访问产品页面时，应用程序将加载十条最近的评论。可以将集合分为两个集合，而不是与产品一起存储所有评论：</p>
<p>产品集合存储有关每个产品的信息，包括产品的十个最新评论：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"Super Widget"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"This is the most useful item in your toolbox."</span>,</span><br><span class="line">  <span class="attr">"price"</span>: &#123; <span class="attr">"value"</span>: NumberDecimal(<span class="string">"119.99"</span>), <span class="attr">"currency"</span>: <span class="string">"USD"</span> &#125;,</span><br><span class="line">  <span class="attr">"reviews"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"review_id"</span>: <span class="number">786</span>,</span><br><span class="line">      <span class="attr">"review_author"</span>: <span class="string">"Kristina"</span>,</span><br><span class="line">      <span class="attr">"review_text"</span>: <span class="string">"This is indeed an amazing widget."</span>,</span><br><span class="line">      <span class="attr">"published_date"</span>: ISODate(<span class="string">"2019-02-18"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"review_id"</span>: <span class="number">776</span>,</span><br><span class="line">      <span class="attr">"review_author"</span>: <span class="string">"Pablo"</span>,</span><br><span class="line">      <span class="attr">"review_text"</span>: <span class="string">"Amazing!"</span>,</span><br><span class="line">      <span class="attr">"published_date"</span>: ISODate(<span class="string">"2019-02-16"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>review collection 存储所有的评论</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"review_id"</span>: <span class="number">786</span>,</span><br><span class="line">  <span class="attr">"product_id"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"review_author"</span>: <span class="string">"Kristina"</span>,</span><br><span class="line">  <span class="attr">"review_text"</span>: <span class="string">"This is indeed an amazing widget."</span>,</span><br><span class="line">  <span class="attr">"published_date"</span>: ISODate(<span class="string">"2019-02-18"</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"review_id"</span>: <span class="number">785</span>,</span><br><span class="line">  <span class="attr">"product_id"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"review_author"</span>: <span class="string">"Trina"</span>,</span><br><span class="line">  <span class="attr">"review_text"</span>: <span class="string">"Nice product. Slow shipping."</span>,</span><br><span class="line">  <span class="attr">"published_date"</span>: ISODate(<span class="string">"2019-02-17"</span>)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"review_id"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"product_id"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"review_author"</span>: <span class="string">"Hans"</span>,</span><br><span class="line">  <span class="attr">"review_text"</span>: <span class="string">"Meh, it's okay."</span>,</span><br><span class="line">  <span class="attr">"published_date"</span>: ISODate(<span class="string">"2017-12-06"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="引用式文档一对多关系模型"><a class="markdownIt-Anchor" href="#引用式文档一对多关系模型"></a> 引用式文档一对多关系模型</h3>
<p>考虑以下映射出版商和书籍关系的示例。</p>
<p>该示例说明了引用式文档的优点，以避免重复发布者信息。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   title: "MongoDB: The Definitive Guide",</span><br><span class="line">   author: [ "Kristina Chodorow", "Mike Dirolf" ],</span><br><span class="line">   published_date: ISODate("2010-09-24"),</span><br><span class="line">   pages: 216,</span><br><span class="line">   language: "English",</span><br><span class="line">   publisher: &#123;</span><br><span class="line">              name: "O'Reilly Media",</span><br><span class="line">              founded: 1980,</span><br><span class="line">              location: "CA"</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   title: "50 Tips and Tricks for MongoDB Developer",</span><br><span class="line">   author: "Kristina Chodorow",</span><br><span class="line">   published_date: ISODate("2011-05-06"),</span><br><span class="line">   pages: 68,</span><br><span class="line">   language: "English",</span><br><span class="line">   publisher: &#123;</span><br><span class="line">              name: "O'Reilly Media",</span><br><span class="line">              founded: 1980,</span><br><span class="line">              location: "CA"</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为避免重复出版商数据，可以使用引用型文档，并将出版商信息与书本分开保存。 使用引用时，关系的增长决定了将引用存储在何处。 如果每个出版商的图书数量很少且增长有限，则有时将图书参考存储在出版商文档中可能会很有用。 否则，如果每个发布者的书籍数量不受限制，则此数据模型将导致可变的，不断增长的数组，如以下示例所示：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   name: "O'Reilly Media",</span><br><span class="line">   founded: 1980,</span><br><span class="line">   location: "CA",</span><br><span class="line">   books: [123456789, 234567890, ...]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    _id: 123456789,</span><br><span class="line">    title: "MongoDB: The Definitive Guide",</span><br><span class="line">    author: [ "Kristina Chodorow", "Mike Dirolf" ],</span><br><span class="line">    published_date: ISODate("2010-09-24"),</span><br><span class="line">    pages: 216,</span><br><span class="line">    language: "English"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   _id: 234567890,</span><br><span class="line">   title: "50 Tips and Tricks for MongoDB Developer",</span><br><span class="line">   author: "Kristina Chodorow",</span><br><span class="line">   published_date: ISODate("2011-05-06"),</span><br><span class="line">   pages: 68,</span><br><span class="line">   language: "English"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了避免可变的，增长的数组，请将发行者参考存储在书籍文档中：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   _id: "oreilly",</span><br><span class="line">   name: "O'Reilly Media",</span><br><span class="line">   founded: 1980,</span><br><span class="line">   location: "CA"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   _id: 123456789,</span><br><span class="line">   title: "MongoDB: The Definitive Guide",</span><br><span class="line">   author: [ "Kristina Chodorow", "Mike Dirolf" ],</span><br><span class="line">   published_date: ISODate("2010-09-24"),</span><br><span class="line">   pages: 216,</span><br><span class="line">   language: "English",</span><br><span class="line">   publisher_id: "oreilly"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   _id: 234567890,</span><br><span class="line">   title: "50 Tips and Tricks for MongoDB Developer",</span><br><span class="line">   author: "Kristina Chodorow",</span><br><span class="line">   published_date: ISODate("2011-05-06"),</span><br><span class="line">   pages: 68,</span><br><span class="line">   language: "English",</span><br><span class="line">   publisher_id: "oreilly"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="树形结构模型"><a class="markdownIt-Anchor" href="#树形结构模型"></a> 树形结构模型</h2>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200911194846.svg" alt="img" /></p>
<h3 id="具有父节点的树形结构模型"><a class="markdownIt-Anchor" href="#具有父节点的树形结构模型"></a> 具有父节点的树形结构模型</h3>
<p>上图结构可以用父引用来表示：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">db.categories.insertMany([</span><br><span class="line">  &#123; "_id": "MongoDB", "parent": "Databases" &#125;,</span><br><span class="line">  &#123; "_id": "dbm", "parent": "Databases" &#125;,</span><br><span class="line">  &#123; "_id": "Databases", "parent": "Programming" &#125;,</span><br><span class="line">  &#123; "_id": "Languages", "parent": "Programming" &#125;,</span><br><span class="line">  &#123; "_id": "Programming", "parent": "Books" &#125;,</span><br><span class="line">  &#123; <span class="attr">"_id"</span>: <span class="string">"Books"</span>, <span class="attr">"parent"</span>: <span class="literal">null</span> &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>检索节点的父节点：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.categories</span><span class="selector-class">.findOne</span>( &#123; <span class="attribute">_id</span>: <span class="string">"MongoDB"</span> &#125; )<span class="selector-class">.parent</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>可以在父字段上创建索引以启用父节点的快速搜索：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.categories</span><span class="selector-class">.createIndex</span>( &#123; <span class="attribute">parent</span>: <span class="number">1</span> &#125; )</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>可以通过父字段查询找到其直接子节点：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.categories</span><span class="selector-class">.find</span>( &#123; <span class="attribute">parent</span>: <span class="string">"Databases"</span> &#125; )</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>检索子树，可以参考： <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/graphLookup/#pipe._S_graphLookup" target="_blank" rel="noopener"><code>$graphLookup</code></a>.</p>
</li>
</ul>
<h3 id="具有子节点的树形结构模型"><a class="markdownIt-Anchor" href="#具有子节点的树形结构模型"></a> 具有子节点的树形结构模型</h3>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">db.categories.insertMany([</span><br><span class="line">  &#123; "_id": "MongoDB", "children": [] &#125;,</span><br><span class="line">  &#123; "_id": "dbm", "children": [] &#125;,</span><br><span class="line">  &#123; "_id": "Databases", "children": ["MongoDB", "dbm"] &#125;,</span><br><span class="line">  &#123; "_id": "Languages", "children": [] &#125;,</span><br><span class="line">  &#123; "_id": "Programming", "children": ["Databases", "Languages"] &#125;,</span><br><span class="line">  &#123; <span class="attr">"_id"</span>: <span class="string">"Books"</span>, <span class="attr">"children"</span>: [<span class="string">"Programming"</span>] &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>检索节点的 children：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.categories</span><span class="selector-class">.findOne</span>( &#123; <span class="attribute">_id</span>: <span class="string">"Databases"</span> &#125; )<span class="selector-class">.children</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>可以在 children 字段上创建索引以启用子节点的快速搜索：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.categories</span><span class="selector-class">.createIndex</span>( &#123; <span class="attribute">children</span>: <span class="number">1</span> &#125; )</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>可以在 children 字段中查询节点，以找到其父节点及其兄弟节点：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.categories</span><span class="selector-class">.find</span>( &#123; <span class="attribute">children</span>: <span class="string">"MongoDB"</span> &#125; )</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="具有祖先的树形结构模型"><a class="markdownIt-Anchor" href="#具有祖先的树形结构模型"></a> 具有祖先的树形结构模型</h3>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">db.categories.insertMany([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"_id"</span>: <span class="string">"MongoDB"</span>,</span><br><span class="line">    <span class="attr">"ancestors"</span>: [<span class="string">"Books"</span>, <span class="string">"Programming"</span>, <span class="string">"Databases"</span>],</span><br><span class="line">    <span class="attr">"parent"</span>: <span class="string">"Databases"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"_id"</span>: <span class="string">"dbm"</span>,</span><br><span class="line">    <span class="attr">"ancestors"</span>: [<span class="string">"Books"</span>, <span class="string">"Programming"</span>, <span class="string">"Databases"</span>],</span><br><span class="line">    <span class="attr">"parent"</span>: <span class="string">"Databases"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"_id"</span>: <span class="string">"Databases"</span>,</span><br><span class="line">    <span class="attr">"ancestors"</span>: [<span class="string">"Books"</span>, <span class="string">"Programming"</span>],</span><br><span class="line">    <span class="attr">"parent"</span>: <span class="string">"Programming"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"_id"</span>: <span class="string">"Languages"</span>,</span><br><span class="line">    <span class="attr">"ancestors"</span>: [<span class="string">"Books"</span>, <span class="string">"Programming"</span>],</span><br><span class="line">    <span class="attr">"parent"</span>: <span class="string">"Programming"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; "_id": "Programming", "ancestors": ["Books"], "parent": "Books" &#125;,</span><br><span class="line">  &#123; <span class="attr">"_id"</span>: <span class="string">"Books"</span>, <span class="attr">"ancestors"</span>: [], <span class="attr">"parent"</span>: <span class="literal">null</span> &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>检索节点的祖先或路径的查询是快速而直接的：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">db.categories.findOne(&#123; "_id": "MongoDB" &#125;).ancestors</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>可以在 ancestors 字段上创建索引，以启用祖先节点的快速搜索：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">db.categories.createIndex(&#123; "ancestors": 1 &#125;)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>可以通过 ancestors 字段查询查找其所有后代：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">db.categories.find(&#123; "ancestors": "Programming" &#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="具有实体化路径的树形结构模型"><a class="markdownIt-Anchor" href="#具有实体化路径的树形结构模型"></a> 具有实体化路径的树形结构模型</h3>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">db.categories.insertMany([</span><br><span class="line">  &#123; "_id": "Books", "path": null &#125;,</span><br><span class="line">  &#123; "_id": "Programming", "path": ",Books," &#125;,</span><br><span class="line">  &#123; "_id": "Databases", "path": ",Books,Programming," &#125;,</span><br><span class="line">  &#123; "_id": "Languages", "path": ",Books,Programming," &#125;,</span><br><span class="line">  &#123; "_id": "MongoDB", "path": ",Books,Programming,Databases," &#125;,</span><br><span class="line">  &#123; <span class="attr">"_id"</span>: <span class="string">"dbm"</span>, <span class="attr">"path"</span>: <span class="string">",Books,Programming,Databases,"</span> &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>可以查询以检索整个树，并按字段路径排序：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.categories</span><span class="selector-class">.find</span>()<span class="selector-class">.sort</span>( &#123; <span class="attribute">path</span>: <span class="number">1</span> &#125; )</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>可以在 path 字段上使用正则表达式来查找 Programming 的后代</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.categories</span><span class="selector-class">.find</span>( &#123; <span class="attribute">path</span>: /,Programming,/ &#125; )</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>可以检索 Books 的后代，其中 Books 也位于层次结构的最高级别：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.categories</span><span class="selector-class">.find</span>( &#123; <span class="attribute">path</span>: /^,Books,/ &#125; )</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>要在 path 字段上创建索引，请使用以下调用：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.categories</span><span class="selector-class">.createIndex</span>( &#123; <span class="attribute">path</span>: <span class="number">1</span> &#125; )</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="具有嵌套集的树形结构模型"><a class="markdownIt-Anchor" href="#具有嵌套集的树形结构模型"></a> 具有嵌套集的树形结构模型</h3>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200911204252.svg" alt="img" /></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.categories.insertMany([</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="string">'Books'</span>, <span class="attr">parent</span>: <span class="number">0</span>, <span class="attr">left</span>: <span class="number">1</span>, <span class="attr">right</span>: <span class="number">12</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="string">'Programming'</span>, <span class="attr">parent</span>: <span class="string">'Books'</span>, <span class="attr">left</span>: <span class="number">2</span>, <span class="attr">right</span>: <span class="number">11</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="string">'Languages'</span>, <span class="attr">parent</span>: <span class="string">'Programming'</span>, <span class="attr">left</span>: <span class="number">3</span>, <span class="attr">right</span>: <span class="number">4</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="string">'Databases'</span>, <span class="attr">parent</span>: <span class="string">'Programming'</span>, <span class="attr">left</span>: <span class="number">5</span>, <span class="attr">right</span>: <span class="number">10</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="string">'MongoDB'</span>, <span class="attr">parent</span>: <span class="string">'Databases'</span>, <span class="attr">left</span>: <span class="number">6</span>, <span class="attr">right</span>: <span class="number">7</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="string">'dbm'</span>, <span class="attr">parent</span>: <span class="string">'Databases'</span>, <span class="attr">left</span>: <span class="number">8</span>, <span class="attr">right</span>: <span class="number">9</span> &#125;,</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>可以查询以检索节点的后代：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> databaseCategory = db.categories.findOne(&#123; <span class="attr">_id</span>: <span class="string">'Databases'</span> &#125;)</span><br><span class="line">db.categories.find(&#123;</span><br><span class="line">  left: &#123; <span class="attr">$gt</span>: databaseCategory.left &#125;,</span><br><span class="line">  right: &#123; <span class="attr">$lt</span>: databaseCategory.right &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="设计模式"><a class="markdownIt-Anchor" href="#设计模式"></a> 设计模式</h2>
<h3 id="大文档很多列很多索引"><a class="markdownIt-Anchor" href="#大文档很多列很多索引"></a> 大文档，很多列，很多索引</h3>
<p>解决方案是：列转行</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200919225901.png" alt="img" /></p>
<h3 id="管理文档不同版本"><a class="markdownIt-Anchor" href="#管理文档不同版本"></a> 管理文档不同版本</h3>
<p>MongoDB 文档格式非常灵活，势必会带来版本维护上的难度。</p>
<p>解决方案是：可以增加一个版本号字段</p>
<ul>
<li>快速过滤掉不需要升级的文档</li>
<li>升级时，对不同版本的文档做不同处理</li>
</ul>
<h3 id="统计网页点击量"><a class="markdownIt-Anchor" href="#统计网页点击量"></a> 统计网页点击量</h3>
<p>统计数据精确性要求并不是十分重要。</p>
<p>解决方案：用近似计算</p>
<p>每隔 10 次写一次：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">"$inc"</span>: &#123; <span class="attr">"views"</span>: <span class="number">1</span> &#125; &#125;</span><br></pre></td></tr></table></figure>
<h3 id="精确统计"><a class="markdownIt-Anchor" href="#精确统计"></a> 精确统计</h3>
<p>解决方案：使用预聚合</p>
<h2 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h2>
<ul>
<li><a href="https://docs.mongodb.com/manual/applications/data-models/" target="_blank" rel="noopener">Data Model Examples and Patterns</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/2020/09/09/mongodb-%E5%BB%BA%E6%A8%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/09/09/mongodb-%E5%BB%BA%E6%A8%A1/" class="post-title-link" itemprop="url">MongoDB 建模</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-09 20:47:14" itemprop="dateCreated datePublished" datetime="2020-09-09T20:47:14+08:00">2020-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-14 16:45:53" itemprop="dateModified" datetime="2022-04-14T16:45:53+08:00">2022-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">文档数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2020/09/09/mongodb-%E5%BB%BA%E6%A8%A1/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/09/09/mongodb-建模/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>7.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mongodb-建模"><a class="markdownIt-Anchor" href="#mongodb-建模"></a> MongoDB 建模</h1>
<p>MongoDB 的数据模式是一种灵活模式，关系型数据库要求你在插入数据之前必须先定义好一个表的模式结构，而 MongoDB 的集合则并不限制 document 结构。这种灵活性让对象和数据库文档之间的映射变得很容易。即使数据记录之间有很大的变化，每个文档也可以很好的映射到各条不同的记录。 当然在实际使用中，同一个集合中的文档往往都有一个比较类似的结构。</p>
<p>数据模型设计中最具挑战性的是在应用程序需求，数据库引擎性能要求和数据读写模式之间做权衡考量。当设计数据模型的时候，一定要考虑应用程序对数据的使用模式（如查询，更新和处理）以及数据本身的天然结构。</p>
<h2 id="mongodb-数据建模入门"><a class="markdownIt-Anchor" href="#mongodb-数据建模入门"></a> MongoDB 数据建模入门</h2>
<blockquote>
<p>参考：<a href="https://docs.mongodb.com/guides/server/introduction/#what-you-ll-need" target="_blank" rel="noopener">https://docs.mongodb.com/guides/server/introduction/#what-you-ll-need</a></p>
</blockquote>
<h3 id="一定义数据集"><a class="markdownIt-Anchor" href="#一定义数据集"></a> （一）定义数据集</h3>
<p>当需要建立数据存储时，首先应该思考以下问题：需要存储哪些数据？这些字段之间如何关联？</p>
<p>这是一个数据建模的过程。目标是<strong>将业务需求抽象为逻辑模型</strong>。</p>
<p>假设这样一个场景：我们需要建立数据库以跟踪物料及其数量，大小，标签和等级。</p>
<p>如果是存储在 RDBMS，可能以下的数据表：</p>
<table>
<thead>
<tr>
<th style="text-align:left">name</th>
<th style="text-align:left">quantity</th>
<th style="text-align:left">size</th>
<th style="text-align:left">status</th>
<th style="text-align:left">tags</th>
<th style="text-align:left">rating</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">journal</td>
<td style="text-align:left">25</td>
<td style="text-align:left">14x21,cm</td>
<td style="text-align:left">A</td>
<td style="text-align:left">brown, lined</td>
<td style="text-align:left">9</td>
</tr>
<tr>
<td style="text-align:left">notebook</td>
<td style="text-align:left">50</td>
<td style="text-align:left">8.5x11,in</td>
<td style="text-align:left">A</td>
<td style="text-align:left">college-ruled,perforated</td>
<td style="text-align:left">8</td>
</tr>
<tr>
<td style="text-align:left">paper</td>
<td style="text-align:left">100</td>
<td style="text-align:left">8.5x11,in</td>
<td style="text-align:left">D</td>
<td style="text-align:left">watercolor</td>
<td style="text-align:left">10</td>
</tr>
<tr>
<td style="text-align:left">planner</td>
<td style="text-align:left">75</td>
<td style="text-align:left">22.85x30,cm</td>
<td style="text-align:left">D</td>
<td style="text-align:left">2019</td>
<td style="text-align:left">10</td>
</tr>
<tr>
<td style="text-align:left">postcard</td>
<td style="text-align:left">45</td>
<td style="text-align:left">10x,cm</td>
<td style="text-align:left">D</td>
<td style="text-align:left">double-sided,white</td>
<td style="text-align:left">2</td>
</tr>
</tbody>
</table>
<h3 id="二思考-json-结构"><a class="markdownIt-Anchor" href="#二思考-json-结构"></a> （二）思考 JSON 结构</h3>
<p>从上例中可以看出，表似乎是存储数据的好地方，但该数据集中的字段需要多个值，如果在单个列中建模，则不容易搜索或显示（对于 例如–大小和标签）。</p>
<p>在 SQL 数据库中，您可以通过创建关系表来解决此问题。</p>
<p>在 MongoDB 中，数据存储为文档（document）。 这些文档以 JSON（JavaScript 对象表示法）格式存储在 MongoDB 中。 JSON 文档支持嵌入式字段，因此相关数据和数据列表可以与文档一起存储，而不是与外部表一起存储。</p>
<p>JSON 格式为键/值对。 在 JSON 文档中，字段名和值用冒号分隔，字段名和值对用逗号分隔，并且字段集封装在“大括号”（<code>{}</code>）中。</p>
<p>如果要开始对上面的行之一进行建模，例如此行：</p>
<table>
<thead>
<tr>
<th style="text-align:left">name</th>
<th style="text-align:left">quantity</th>
<th style="text-align:left">size</th>
<th style="text-align:left">status</th>
<th style="text-align:left">tags</th>
<th style="text-align:left">rating</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">notebook</td>
<td style="text-align:left">50</td>
<td style="text-align:left">8.5x11,in</td>
<td style="text-align:left">A</td>
<td style="text-align:left">college-ruled,perforated</td>
<td style="text-align:left">8</td>
</tr>
</tbody>
</table>
<p>您可以从 name 和 quantity 字段开始。 在 JSON 中，这些字段如下所示：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">"name"</span>: <span class="string">"notebook"</span>, <span class="attr">"qty"</span>: <span class="number">50</span> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="三确定哪些字段作为嵌入式数据"><a class="markdownIt-Anchor" href="#三确定哪些字段作为嵌入式数据"></a> （三）确定哪些字段作为嵌入式数据</h3>
<p>接下来，需要确定哪些字段可能需要多个值。可以考虑将这些字段作为嵌入式文档或嵌入式文档中的 列表/数组 对象。</p>
<p>例如，在上面的示例中，size 可能包含三个字段：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">"h"</span>: <span class="number">11</span>, <span class="attr">"w"</span>: <span class="number">8.5</span>, <span class="attr">"uom"</span>: <span class="string">"in"</span> &#125;</span><br></pre></td></tr></table></figure>
<p>And some items have multiple ratings, so <code>ratings</code> might be represented as a list of documents containing the field <code>scores</code>:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[&#123; <span class="attr">"score"</span>: <span class="number">8</span> &#125;, &#123; <span class="attr">"score"</span>: <span class="number">9</span> &#125;]</span><br></pre></td></tr></table></figure>
<p>And you might need to handle multiple tags per item. So you might store them in a list too.</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[<span class="string">"college-ruled"</span>, <span class="string">"perforated"</span>]</span><br></pre></td></tr></table></figure>
<p>Finally, a JSON document that stores an inventory item might look like this:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"notebook"</span>,</span><br><span class="line">  <span class="attr">"qty"</span>: <span class="number">50</span>,</span><br><span class="line">  <span class="attr">"rating"</span>: [&#123; <span class="attr">"score"</span>: <span class="number">8</span> &#125;, &#123; <span class="attr">"score"</span>: <span class="number">9</span> &#125;],</span><br><span class="line">  <span class="attr">"size"</span>: &#123; <span class="attr">"height"</span>: <span class="number">11</span>, <span class="attr">"width"</span>: <span class="number">8.5</span>, <span class="attr">"unit"</span>: <span class="string">"in"</span> &#125;,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="string">"A"</span>,</span><br><span class="line">  <span class="attr">"tags"</span>: [<span class="string">"college-ruled"</span>, <span class="string">"perforated"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This looks very different from the tabular data structure you started with in Step 1.</p>
<h2 id="数据模型简介"><a class="markdownIt-Anchor" href="#数据模型简介"></a> 数据模型简介</h2>
<p>数据建模中的关键挑战是平衡应用程序的需求、数据库引擎的性能以及数据检索模式。 在设计数据模型时，始终需要考虑数据的应用程序使用情况（即数据的查询，更新和处理）以及数据本身的固有结构。</p>
<h3 id="灵活的-schema"><a class="markdownIt-Anchor" href="#灵活的-schema"></a> 灵活的 Schema</h3>
<p>在关系型数据库中，必须在插入数据之前确定并声明表的结构。而 MongoDB 的 collection 默认情况下不需要其文档具有相同的架构。也就是说：</p>
<p>同一个 collection 中的 document 不需要具有相同的 field 集，并且 field 的数据类型可以在集合中的不同文档之间有所不同。</p>
<p>要更改 collection 中的 document 结构，例如添加新 field，删除现有 field 或将 field 值更改为新类型，只需要将文档更新为新结构即可。</p>
<p>这种灵活性有助于将 document 映射到实体或对象。每个 document 都可以匹配所表示实体的数据字段，即使该文档与集合中的其他文档有很大的不同。但是，实际上，集合中的文档具有相似的结构，并且您可以在更新和插入操作期间对 collection 强制执行 document 校验规则。</p>
<h3 id="document-结构"><a class="markdownIt-Anchor" href="#document-结构"></a> Document 结构</h3>
<h4 id="嵌入式数据模型"><a class="markdownIt-Anchor" href="#嵌入式数据模型"></a> 嵌入式数据模型</h4>
<p>嵌入式 document 通过将相关数据存储在单个 document 结构中来捕获数据之间的关系。 MongoDB document 可以将 document 结构嵌入到另一个 document 中的字段或数组中。这些非规范化的数据模型允许应用程序在单个数据库操作中检索和操纵相关数据。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200910193231.png" alt="img" /></p>
<p>对于 MongoDB 中的很多场景，非规范化数据模型都是最佳的。</p>
<blockquote>
<p>嵌入式 document 有大小限制：必须小于 16 MB。</p>
<p>如果是较大的二进制数据，可以考虑 <a href="https://docs.mongodb.com/manual/core/gridfs/" target="_blank" rel="noopener">GridFS</a>。</p>
</blockquote>
<h4 id="引用式数据模型"><a class="markdownIt-Anchor" href="#引用式数据模型"></a> 引用式数据模型</h4>
<p>引用通过包含从一个 document 到另一个 document 的链接或引用来存储数据之间的关系。 应用程序可以解析这些引用以访问相关数据。 广义上讲，这些是规范化的数据模型。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200910193234.png" alt="img" /></p>
<p>通常，在以下场景使用引用式的数据模型：</p>
<ul>
<li>嵌入时会导致数据重复，但无法提供足够的读取性能优势，无法胜过重复的含义。</li>
<li>代表更复杂的多对多关系。</li>
<li>为大规模分层数据集建模。</li>
</ul>
<p>为了 join collection，MongoDB 支持聚合 stage：</p>
<ul>
<li><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/#pipe._S_lookup" target="_blank" rel="noopener"><code>$lookup</code></a>（MongoDB 3.2 开始支持）</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/graphLookup/#pipe._S_graphLookup" target="_blank" rel="noopener"><code>$graphLookup</code></a>（MongoDB 3.4 开始支持）</li>
</ul>
<p>MongoDB 还提供了引用来支持跨集合 join 数据：</p>
<ul>
<li>引用数据模型示例，参考：<a href="https://docs.mongodb.com/manual/tutorial/model-referenced-one-to-many-relationships-between-documents/#data-modeling-publisher-and-books" target="_blank" rel="noopener">Model One-to-Many Relationships with Document References</a>.</li>
<li>更多树形模型，参考：<a href="https://docs.mongodb.com/manual/applications/data-models-tree-structures/" target="_blank" rel="noopener">Model Tree Structures</a>.</li>
</ul>
<h3 id="原子写操作"><a class="markdownIt-Anchor" href="#原子写操作"></a> 原子写操作</h3>
<h4 id="单-document-的原子性"><a class="markdownIt-Anchor" href="#单-document-的原子性"></a> 单 document 的原子性</h4>
<p>在 MongoDB 中，针对单个 document 的写操作是原子性的，即使该 document 中嵌入了多个子 document。 具有嵌入数据的非规范化数据模型将所有相关数据合并在一个 document 中，而不是在多个 document 和 collection 中进行规范化。 该数据模型有助于原子操作。 当单个写入操作（例如 <a href="https://docs.mongodb.com/manual/reference/method/db.collection.updateMany/#db.collection.updateMany" target="_blank" rel="noopener"><code>db.collection.updateMany()</code></a>）修改多个 document 时，每个 document 的独立修改是原子的，但整个操作不是原子的。</p>
<h4 id="多-document-事务"><a class="markdownIt-Anchor" href="#多-document-事务"></a> 多 document 事务</h4>
<p>对于需要对多个 document（在单个或多个集合中）进行读写原子性的情况，MongoDB 支持多 document 事务。</p>
<ul>
<li>在版本 4.0 中，MongoDB 在副本集上支持多 document 事务。</li>
<li>在版本 4.2 中，MongoDB 引入了分布式事务，它增加了对分片群集上多 document 事务的支持，并合并了对副本集上多 document 事务的现有支持。</li>
</ul>
<blockquote>
<p>在大多数情况下，多 document 事务会比单 document 的写入产生更高的性能消耗，并且多 document 事务的可用性不能替代高效的结构设计。 在许多情况下，非规范化数据模型（嵌入式 document 和数组）仍是最佳选择。 也就是说，合理的数据建模，将最大程度地减少对多 document 事务的需求。</p>
</blockquote>
<h3 id="数据使用和性能"><a class="markdownIt-Anchor" href="#数据使用和性能"></a> 数据使用和性能</h3>
<p>在设计数据模型时，请考虑应用程序将如何使用您的数据库。 例如，如果您的应用程序仅使用最近插入的 document，请考虑使用上限集合。 或者，如果您的应用程序主要是对 collection 的读取操作，则添加索引以提高性能。</p>
<h2 id="schema-校验"><a class="markdownIt-Anchor" href="#schema-校验"></a> Schema 校验</h2>
<h3 id="指定校验规则"><a class="markdownIt-Anchor" href="#指定校验规则"></a> 指定校验规则</h3>
<p>如果创建新 collection 时要指定校验规则，需要在使用 <a href="https://docs.mongodb.com/manual/reference/method/db.createCollection/#db.createCollection" target="_blank" rel="noopener"><code>db.createCollection()</code></a> 时指定 <code>validator</code> 选项。</p>
<p>如果要将 document 校验添加到现有 collection 中，需要使用带有 <code>validator</code> 选项的 <a href="https://docs.mongodb.com/manual/reference/command/collMod/#dbcmd.collMod" target="_blank" rel="noopener"><code>collMod</code></a> 命令。</p>
<p>MongoDB 还提供以下相关选项：</p>
<ul>
<li><code>validationLevel</code> 选项（用于确定 MongoDB 在更新过程中，对现有 document 应用校验规则的严格程度）</li>
<li><code>validationAction</code> 选项（用于确定 MongoDB 发现违反校验规则的 document 时，是选择报错并拒绝，还是接受数据但在日志中告警）。</li>
</ul>
<h3 id="json-schema"><a class="markdownIt-Anchor" href="#json-schema"></a> JSON Schema</h3>
<p>从 3.6 版本开始，MongoDB 开始支持 JSON Schema 校验。</p>
<p>可以通过在 validator 表达式中使用 <a href="https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/#op._S_jsonSchema" target="_blank" rel="noopener"><code>$jsonSchema</code></a> 操作来指定 JSON Schema 校验。</p>
<p>【示例】</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.createCollection(<span class="string">'students'</span>, &#123;</span><br><span class="line">  validator: &#123;</span><br><span class="line">    $jsonSchema: &#123;</span><br><span class="line">      bsonType: <span class="string">'object'</span>,</span><br><span class="line">      required: [<span class="string">'name'</span>, <span class="string">'year'</span>, <span class="string">'major'</span>, <span class="string">'address'</span>],</span><br><span class="line">      properties: &#123;</span><br><span class="line">        name: &#123;</span><br><span class="line">          bsonType: <span class="string">'string'</span>,</span><br><span class="line">          description: <span class="string">'must be a string and is required'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        year: &#123;</span><br><span class="line">          bsonType: <span class="string">'int'</span>,</span><br><span class="line">          minimum: <span class="number">2017</span>,</span><br><span class="line">          maximum: <span class="number">3017</span>,</span><br><span class="line">          description: <span class="string">'must be an integer in [ 2017, 3017 ] and is required'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        major: &#123;</span><br><span class="line">          enum: [<span class="string">'Math'</span>, <span class="string">'English'</span>, <span class="string">'Computer Science'</span>, <span class="string">'History'</span>, <span class="literal">null</span>],</span><br><span class="line">          description: <span class="string">'can only be one of the enum values and is required'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        gpa: &#123;</span><br><span class="line">          bsonType: [<span class="string">'double'</span>],</span><br><span class="line">          description: <span class="string">'must be a double if the field exists'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        address: &#123;</span><br><span class="line">          bsonType: <span class="string">'object'</span>,</span><br><span class="line">          required: [<span class="string">'city'</span>],</span><br><span class="line">          properties: &#123;</span><br><span class="line">            street: &#123;</span><br><span class="line">              bsonType: <span class="string">'string'</span>,</span><br><span class="line">              description: <span class="string">'must be a string if the field exists'</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            city: &#123;</span><br><span class="line">              bsonType: <span class="string">'string'</span>,</span><br><span class="line">              description: <span class="string">'must be a string and is required'</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="其它查询表达式"><a class="markdownIt-Anchor" href="#其它查询表达式"></a> 其它查询表达式</h3>
<p>除了使用 <a href="https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/#op._S_jsonSchema" target="_blank" rel="noopener"><code>$jsonSchema</code></a> 查询运算符的 JSON Schema 校验外，MongoDB 还支持其它查询运算符的校验，但以下情况除外：</p>
<ul>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/near/#op._S_near" target="_blank" rel="noopener"><code>$near</code></a>,</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/nearSphere/#op._S_nearSphere" target="_blank" rel="noopener"><code>$nearSphere</code></a>,</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/text/#op._S_text" target="_blank" rel="noopener"><code>$text</code></a>,</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/where/#op._S_where" target="_blank" rel="noopener"><code>$where</code></a>, and</li>
<li>带有 <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/function/#exp._S_function" target="_blank" rel="noopener"><code>$function</code></a> 表达式的 <a href="https://docs.mongodb.com/manual/reference/operator/query/expr/#op._S_expr" target="_blank" rel="noopener"><code>$expr</code></a></li>
</ul>
<p>【示例】查询表达式中指定校验规则</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.createCollection(<span class="string">'contacts'</span>, &#123;</span><br><span class="line">  validator: &#123;</span><br><span class="line">    $or: [</span><br><span class="line">      &#123; <span class="attr">phone</span>: &#123; <span class="attr">$type</span>: <span class="string">'string'</span> &#125; &#125;,</span><br><span class="line">      &#123; <span class="attr">email</span>: &#123; <span class="attr">$regex</span>: <span class="regexp">/@mongodb\.com$/</span> &#125; &#125;,</span><br><span class="line">      &#123; <span class="attr">status</span>: &#123; <span class="attr">$in</span>: [<span class="string">'Unknown'</span>, <span class="string">'Incomplete'</span>] &#125; &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="行为"><a class="markdownIt-Anchor" href="#行为"></a> 行为</h3>
<p>校验发生在更新和插入期间。添加校验规则到 collection 时，不会对现有的 document 进行校验，除非发生修改操作。</p>
<h4 id="现有的-document"><a class="markdownIt-Anchor" href="#现有的-document"></a> 现有的 document</h4>
<p><code>validationLevel</code> 选项确定 MongoDB 进行规则校验时执行的操作：</p>
<ul>
<li>如果 <code>validationLevel</code> 是 strict（严格级别。这是 MongoDB 默认级别），则 MongoDB 将校验规则应用于所有插入和更新。</li>
<li>如果 <code>validationLevel</code> 是 moderate（中等级别），则 MongoDB 只对已满足校验条件的现有文档的插入和更新操作进行校验；对不符合校验标准的现有文档的更新操作不进行校验。</li>
</ul>
<p>【示例】</p>
<p>下面是一个正常的插入操作：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.contacts.insert([</span><br><span class="line">  &#123;</span><br><span class="line">    _id: <span class="number">1</span>,</span><br><span class="line">    name: <span class="string">'Anne'</span>,</span><br><span class="line">    phone: <span class="string">'+1 555 123 456'</span>,</span><br><span class="line">    city: <span class="string">'London'</span>,</span><br><span class="line">    status: <span class="string">'Complete'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">'Ivan'</span>, <span class="attr">city</span>: <span class="string">'Vancouver'</span> &#125;,</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>在 collection 上配置一个校验规则：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.runCommand(&#123;</span><br><span class="line">  collMod: <span class="string">'contacts'</span>,</span><br><span class="line">  validator: &#123;</span><br><span class="line">    $jsonSchema: &#123;</span><br><span class="line">      bsonType: <span class="string">'object'</span>,</span><br><span class="line">      required: [<span class="string">'phone'</span>, <span class="string">'name'</span>],</span><br><span class="line">      properties: &#123;</span><br><span class="line">        phone: &#123;</span><br><span class="line">          bsonType: <span class="string">'string'</span>,</span><br><span class="line">          description: <span class="string">'must be a string and is required'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        name: &#123;</span><br><span class="line">          bsonType: <span class="string">'string'</span>,</span><br><span class="line">          description: <span class="string">'must be a string and is required'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  validationLevel: <span class="string">'moderate'</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>则 <code>contacts</code> collection 现在添加了含中等级别（moderate） validationLevel 的 <code>validator</code>：</p>
<ul>
<li>
<p>如果尝试更新 <code>_id</code>为 1 的文档，则 MongoDB 将应用校验规则，因为现有文档符合条件。</p>
</li>
<li>
<p>相反，MongoDB 不会将校验 <code>_id</code> 为 2 的文档，因为它不符合校验规则。</p>
</li>
</ul>
<p>如果要完全禁用校验，可以将 <code>validationLevel</code> 置为 <code>off</code>。</p>
<h4 id="接受或拒绝无效的-document"><a class="markdownIt-Anchor" href="#接受或拒绝无效的-document"></a> 接受或拒绝无效的 document</h4>
<ul>
<li>如果 validationAction 是 Error（默认），则 MongoDB 拒绝任何违反校验规则的插入或更新。</li>
<li>如果 validationAction 是 Warn，MongoDB 会记录所有的违规，但允许进行插入或更新。</li>
</ul>
<p>【示例】</p>
<p>创建集合时，配置 <code>validationAction</code> 为 warn。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.createCollection(<span class="string">'contacts2'</span>, &#123;</span><br><span class="line">  validator: &#123;</span><br><span class="line">    $jsonSchema: &#123;</span><br><span class="line">      bsonType: <span class="string">'object'</span>,</span><br><span class="line">      required: [<span class="string">'phone'</span>],</span><br><span class="line">      properties: &#123;</span><br><span class="line">        phone: &#123;</span><br><span class="line">          bsonType: <span class="string">'string'</span>,</span><br><span class="line">          description: <span class="string">'must be a string and is required'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        email: &#123;</span><br><span class="line">          bsonType: <span class="string">'string'</span>,</span><br><span class="line">          pattern: <span class="string">'@mongodb.com$'</span>,</span><br><span class="line">          description:</span><br><span class="line">            <span class="string">'must be a string and match the regular expression pattern'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        status: &#123;</span><br><span class="line">          enum: [<span class="string">'Unknown'</span>, <span class="string">'Incomplete'</span>],</span><br><span class="line">          description: <span class="string">'can only be one of the enum values'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  validationAction: <span class="string">'warn'</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>尝试插入一条违规记录</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&gt; db.contacts2.insert( &#123; <span class="attr">name</span>: <span class="string">"Amanda"</span>, <span class="attr">status</span>: <span class="string">"Updated"</span> &#125; )</span><br><span class="line">WriteResult(&#123; <span class="string">"nInserted"</span> : <span class="number">1</span> &#125;)</span><br></pre></td></tr></table></figure>
<p>MongoDB 允许这条操作执行，但是服务器会记录下告警信息。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"t"</span>:&#123;<span class="attr">"$date"</span>:<span class="string">"2020-09-11T16:35:57.754+08:00"</span>&#125;,<span class="attr">"s"</span>:<span class="string">"W"</span>,  <span class="attr">"c"</span>:<span class="string">"STORAGE"</span>,  <span class="attr">"id"</span>:<span class="number">20294</span>,   <span class="attr">"ctx"</span>:<span class="string">"conn14"</span>,<span class="attr">"msg"</span>:<span class="string">"Document would fail validation"</span>,<span class="attr">"attr"</span>:&#123;<span class="attr">"namespace"</span>:<span class="string">"test.contacts2"</span>,<span class="attr">"document"</span>:&#123;<span class="attr">"_id"</span>:&#123;<span class="attr">"$oid"</span>:<span class="string">"5f5b36ed8ea53d62a0b51c4e"</span>&#125;,<span class="attr">"name"</span>:<span class="string">"Amanda"</span>,<span class="attr">"status"</span>:<span class="string">"Updated"</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="限制"><a class="markdownIt-Anchor" href="#限制"></a> 限制</h4>
<p>不能在 <code>admin</code>、<code>local</code>、<code>config</code> 这几个特殊的数据库中指定校验规则。</p>
<p>不能在 <code>system.*</code> collection 中指定校验。</p>
<h2 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h2>
<ul>
<li><strong>官方</strong>
<ul>
<li><a href="https://www.mongodb.com/" target="_blank" rel="noopener">MongoDB 官网</a></li>
<li><a href="https://github.com/mongodb/mongo" target="_blank" rel="noopener">MongoDB Github</a></li>
<li><a href="https://university.mongodb.com/" target="_blank" rel="noopener">MongoDB 官方免费教程</a></li>
</ul>
</li>
<li><strong>教程</strong>
<ul>
<li><a href="https://www.runoob.com/mongodb/mongodb-tutorial.html" target="_blank" rel="noopener">MongoDB 教程</a></li>
<li><a href="https://time.geekbang.org/course/intro/100040001" target="_blank" rel="noopener">MongoDB 高手课</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/2020/09/09/mongodb-%E8%BF%90%E7%BB%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/09/09/mongodb-%E8%BF%90%E7%BB%B4/" class="post-title-link" itemprop="url">MongoDB 运维</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-09 20:47:14" itemprop="dateCreated datePublished" datetime="2020-09-09T20:47:14+08:00">2020-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-14 16:45:53" itemprop="dateModified" datetime="2022-04-14T16:45:53+08:00">2022-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">文档数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2020/09/09/mongodb-%E8%BF%90%E7%BB%B4/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/09/09/mongodb-运维/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mongodb-运维"><a class="markdownIt-Anchor" href="#mongodb-运维"></a> MongoDB 运维</h1>
<h2 id="mongodb-安装"><a class="markdownIt-Anchor" href="#mongodb-安装"></a> MongoDB 安装</h2>
<h3 id="windows"><a class="markdownIt-Anchor" href="#windows"></a> Windows</h3>
<p>（1）下载并解压到本地</p>
<p>进入官网下载地址：<a href="https://www.mongodb.com/try/download/community" target="_blank" rel="noopener"><strong>官方下载地址</strong></a> ，选择合适的版本下载。</p>
<p>（2）创建数据目录</p>
<p>MongoDB 将数据目录存储在 db 目录下。但是这个数据目录不会主动创建，我们在安装完成后需要创建它。</p>
<p>例如：<code>D:\Tools\Server\mongodb\mongodb-4.4.0\data\db</code></p>
<p>（3）运行 MongoDB 服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mongod --dbpath D:\Tools\Server\mongodb\mongodb-4.4.0\data\db</span><br></pre></td></tr></table></figure>
<p>（4）客户端连接 MongoDB</p>
<p>可以在命令窗口中运行 mongo.exe 命令即可连接上 MongoDB</p>
<p>（5）配置 MongoDB 服务</p>
<h3 id="linux"><a class="markdownIt-Anchor" href="#linux"></a> Linux</h3>
<p>（1）使用安装包安装</p>
<p>安装前我们需要安装各个 Linux 平台依赖包。</p>
<p><strong>Red Hat/CentOS：</strong></p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">sudo yum <span class="keyword">install</span> libcurl openssl</span><br></pre></td></tr></table></figure>
<p><strong>Ubuntu 18.04 LTS (“Bionic”)/Debian 10 “Buster”：</strong></p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo apt-<span class="builtin-name">get</span> install libcurl4 openssl</span><br></pre></td></tr></table></figure>
<p><strong>Ubuntu 16.04 LTS (“Xenial”)/Debian 9 “Stretch”：</strong></p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo apt-<span class="builtin-name">get</span> install libcurl3 openssl</span><br></pre></td></tr></table></figure>
<p>（2）创建数据目录</p>
<p>默认情况下 MongoDB 启动后会初始化以下两个目录：</p>
<ul>
<li>数据存储目录：/var/lib/mongodb</li>
<li>日志文件目录：/var/log/mongodb</li>
</ul>
<p>我们在启动前可以先创建这两个目录并设置当前用户有读写权限：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo mkdir -p /var/lib/mongo</span><br><span class="line">sudo mkdir -p /var/log/mongodb</span><br><span class="line">sudo chown `whoami` /var/lib/mongo     # 设置权限</span><br><span class="line">sudo chown `whoami` /var/log/mongodb   # 设置权限</span><br></pre></td></tr></table></figure>
<p>（3）运行 MongoDB 服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mongod --dbpath /var/lib/mongo --logpath /var/log/mongodb/mongod.log --fork</span><br></pre></td></tr></table></figure>
<p>打开 /var/log/mongodb/mongod.log 文件看到以下信息，说明启动成功。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> tail -10f /var/<span class="built_in">log</span>/mongodb/mongod.log</span></span><br><span class="line">2020-07-09T12:20:17.391+0800 I  NETWORK  [listener] Listening on /tmp/mongodb-27017.sock</span><br><span class="line">2020-07-09T12:20:17.392+0800 I  NETWORK  [listener] Listening on 127.0.0.1</span><br><span class="line">2020-07-09T12:20:17.392+0800 I  NETWORK  [listener] waiting for connections on port 27017</span><br></pre></td></tr></table></figure>
<p>（4）客户端连接 MongoDB</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /usr/local/mongodb4/bin</span><br><span class="line">./mongo</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://github.com/dunwu/linux-tutorial/tree/master/codes/linux/soft" target="_blank" rel="noopener">Linux 安装脚本</a></p>
</blockquote>
<h3 id="设置用户名-密码"><a class="markdownIt-Anchor" href="#设置用户名-密码"></a> 设置用户名、密码</h3>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> use admin</span></span><br><span class="line">switched to db admin</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> db.createUser(&#123;<span class="string">"user"</span>:<span class="string">"root"</span>,<span class="string">"pwd"</span>:<span class="string">"root"</span>,<span class="string">"roles"</span>:[&#123;<span class="string">"role"</span>:<span class="string">"userAdminAnyDatabase"</span>,<span class="string">"db"</span>:<span class="string">"admin"</span>&#125;]&#125;)</span></span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">        "user" : "root",</span><br><span class="line">        "roles" : [</span><br><span class="line">                &#123;</span><br><span class="line">                        "role" : "userAdminAnyDatabase",</span><br><span class="line">                        "db" : "admin"</span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="备份和恢复"><a class="markdownIt-Anchor" href="#备份和恢复"></a> 备份和恢复</h2>
<h3 id="数据备份"><a class="markdownIt-Anchor" href="#数据备份"></a> 数据备份</h3>
<p>在 Mongodb 中，使用 <code>mongodump</code> 命令来备份 MongoDB 数据。该命令可以导出所有数据到指定目录中。</p>
<p><code>mongodump</code> 命令可以通过参数指定导出的数据量级转存的服务器。</p>
<p>mongodump 命令语法如下：</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">mongodump -h dbhost -d dbname -o dbdirectory</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>-h：MongDB 所在服务器地址，例如：127.0.0.1，当然也可以指定端口号：127.0.0.1:27017</p>
</li>
<li>
<p>-d：需要备份的数据库实例，例如：test</p>
</li>
<li>
<p>-o：备份的数据存放位置，例如：c:\data\dump，当然该目录需要提前建立，在备份完成后，系统自动在 dump 目录下建立一个 test 目录，这个目录里面存放该数据库实例的备份数据。</p>
</li>
</ul>
<p><code>mongodump</code> 命令可选参数列表如下所示：</p>
<table>
<thead>
<tr>
<th style="text-align:left">语法</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">实例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">mongodump --host HOST_NAME --port PORT_NUMBER</td>
<td style="text-align:left">该命令将备份所有 MongoDB 数据</td>
<td style="text-align:left">mongodump --host <a href="http://runoob.com" target="_blank" rel="noopener">runoob.com</a> --port 27017</td>
</tr>
<tr>
<td style="text-align:left">mongodump --dbpath DB_PATH --out BACKUP_DIRECTORY</td>
<td style="text-align:left"></td>
<td style="text-align:left">mongodump --dbpath /data/db/ --out /data/backup/</td>
</tr>
<tr>
<td style="text-align:left">mongodump --collection COLLECTION --db DB_NAME</td>
<td style="text-align:left">该命令将备份指定数据库的集合。</td>
<td style="text-align:left">mongodump --collection mycol --db test</td>
</tr>
</tbody>
</table>
<p>【示例】备份全量数据</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mongodump -h 127.0.0.1 --port 27017 -o test2</span></span><br><span class="line">...</span><br><span class="line">2020-09-11T11:55:58.086+0800    done dumping test.company (18801 documents)</span><br><span class="line">2020-09-11T11:56:00.725+0800    [#############...........]  test.people  559101/1000000  (55.9%)</span><br><span class="line">2020-09-11T11:56:03.725+0800    [###################.....]  test.people  829496/1000000  (82.9%)</span><br><span class="line">2020-09-11T11:56:06.725+0800    [#####################...]  test.people  884614/1000000  (88.5%)</span><br><span class="line">2020-09-11T11:56:08.088+0800    [########################]  test.people  1000000/1000000  (100.0%)</span><br><span class="line">2020-09-11T11:56:08.350+0800    done dumping test.people (1000000 documents)</span><br></pre></td></tr></table></figure>
<p>【示例】备份指定数据库</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mongodump -h 127.0.0.1 --port 27017 -d admin -o test3</span><br></pre></td></tr></table></figure>
<h3 id="数据恢复"><a class="markdownIt-Anchor" href="#数据恢复"></a> 数据恢复</h3>
<p>mongodb 使用 <code>mongorestore</code> 命令来恢复备份的数据。</p>
<p><code>mongorestore</code> 命令语法如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mongorestore -h &lt;hostname&gt;&lt;:port&gt; -d dbname &lt;path&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><code>--host &lt;:port&gt;</code>, <code>-h &lt;:port&gt;</code>：MongoDB 所在服务器地址，默认为： localhost:27017</p>
</li>
<li>
<p><code>--db</code> , <code>-d</code> ：需要恢复的数据库实例，例如：test，当然这个名称也可以和备份时候的不一样，比如 test2</p>
</li>
<li>
<p><code>--drop</code>：恢复的时候，先删除当前数据，然后恢复备份的数据。就是说，恢复后，备份后添加修改的数据都会被删除，慎用哦！</p>
</li>
<li>
<p><code>&lt;path&gt;</code>：mongorestore 最后的一个参数，设置备份数据所在位置，例如：c:\data\dump\test。你不能同时指定 <code>&lt;path&gt;</code> 和 <code>--dir</code> 选项，<code>--dir</code> 也可以设置备份目录。</p>
</li>
<li>
<p><code>--dir</code>：指定备份的目录。你不能同时指定 <code>&lt;path&gt;</code> 和 <code>--dir</code> 选项。</p>
</li>
</ul>
<p>【示例】</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mongorestore -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> --dir <span class="built_in">test</span> --drop</span></span><br><span class="line">...</span><br><span class="line">2020-09-11T11:46:16.053+0800    finished restoring test.tweets (966 documents, 0 failures)</span><br><span class="line">2020-09-11T11:46:18.256+0800    [###.....................]  test.people  164MB/1.03GB  (15.6%)</span><br><span class="line">2020-09-11T11:46:21.255+0800    [########................]  test.people  364MB/1.03GB  (34.6%)</span><br><span class="line">2020-09-11T11:46:24.256+0800    [############............]  test.people  558MB/1.03GB  (53.0%)</span><br><span class="line">2020-09-11T11:46:27.255+0800    [###############.........]  test.people  700MB/1.03GB  (66.5%)</span><br><span class="line">2020-09-11T11:46:30.257+0800    [###################.....]  test.people  846MB/1.03GB  (80.3%)</span><br><span class="line">2020-09-11T11:46:33.255+0800    [######################..]  test.people  990MB/1.03GB  (94.0%)</span><br><span class="line">2020-09-11T11:46:34.542+0800    [########################]  test.people  1.03GB/1.03GB  (100.0%)</span><br><span class="line">2020-09-11T11:46:34.543+0800    no indexes to restore</span><br><span class="line">2020-09-11T11:46:34.543+0800    finished restoring test.people (1000000 documents, 0 failures)</span><br><span class="line">2020-09-11T11:46:34.544+0800    1000966 document(s) restored successfully. 0 document(s) failed to restore.</span><br></pre></td></tr></table></figure>
<h2 id="导入导出"><a class="markdownIt-Anchor" href="#导入导出"></a> 导入导出</h2>
<p><code>mongoimport</code> 和 <code>mongoexport</code> 并不能可靠地保存所有的富文本 BSON 数据类型，因为 JSON 仅能代表一种 BSON 支持的子集类型。因此，数据用这些工具导出导入或许会丢失一些精确程度。</p>
<h3 id="导入操作"><a class="markdownIt-Anchor" href="#导入操作"></a> 导入操作</h3>
<p>在 MongoDB 中，使用 <code>mongoimport</code> 来导入数据。 默认情况下，<code>mongoimport</code> 会将数据导入到本地主机端口 27017 上的 MongoDB 实例中。要将数据导入在其他主机或端口上运行的 MongoDB 实例中，请通过包含 <code>--host</code> 和 <code>--port</code> 选项来指定主机名或端口。 使用 <code>--drop</code> 选项删除集合（如果已经存在）。 这样可以确保该集合仅包含您要导入的数据。</p>
<p>语法格式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mongoimport -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -c 表名 --<span class="built_in">type</span> 类型 --headerline --upsert --drop 文件名</span><br></pre></td></tr></table></figure>
<p>【示例】导入表数据</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mongoimport -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> -c book --drop <span class="built_in">test</span>/book.dat</span></span><br><span class="line">2020-09-11T10:53:56.359+0800    connected to: mongodb://127.0.0.1:27017/</span><br><span class="line">2020-09-11T10:53:56.372+0800    dropping: test.book</span><br><span class="line">2020-09-11T10:53:56.628+0800    431 document(s) imported successfully. 0 document(s) failed to import.</span><br></pre></td></tr></table></figure>
<p>【示例】从 json 文件中导入表数据</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mongoimport -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> -c student --upsert <span class="built_in">test</span>/student.json</span></span><br><span class="line">2020-09-11T11:02:55.907+0800    connected to: mongodb://127.0.0.1:27017/</span><br><span class="line">2020-09-11T11:02:56.068+0800    200 document(s) imported successfully. 0 document(s) failed to import.</span><br></pre></td></tr></table></figure>
<p>【示例】从 csv 文件中导入表数据</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mongoimport -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> -c product --<span class="built_in">type</span> csv --headerline <span class="built_in">test</span>/product.csv</span></span><br><span class="line">2020-09-11T11:07:49.788+0800    connected to: mongodb://127.0.0.1:27017/</span><br><span class="line">2020-09-11T11:07:51.051+0800    11 document(s) imported successfully. 0 document(s) failed to import.</span><br></pre></td></tr></table></figure>
<p>【示例】导入部分表字段数据</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mongoimport -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> -c product --<span class="built_in">type</span> json --upsertFields name,price <span class="built_in">test</span>/product.json</span></span><br><span class="line">2020-09-11T11:14:05.410+0800    connected to: mongodb://127.0.0.1:27017/</span><br><span class="line">2020-09-11T11:14:05.612+0800    11 document(s) imported successfully. 0 document(s) failed to import.</span><br></pre></td></tr></table></figure>
<h3 id="导出操作"><a class="markdownIt-Anchor" href="#导出操作"></a> 导出操作</h3>
<p>语法格式：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mongoexport -h &lt;IP&gt; --port &lt;端口&gt; -u &lt;用户名&gt; -p &lt;密码&gt; -d &lt;数据库&gt; -c &lt;表名&gt; -f &lt;字段&gt; -q &lt;条件导出&gt; --csv -o &lt;文件名&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-f</code>：导出指字段，以逗号分割，<code>-f name,email,age</code> 导出 name,email,age 这三个字段</li>
<li><code>-q</code>：可以根查询条件导出，<code>-q '{ &quot;uid&quot; : &quot;100&quot; }'</code> 导出 uid 为 100 的数据</li>
<li><code>--csv</code>：表示导出的文件格式为 csv 的，这个比较有用，因为大部分的关系型数据库都是支持 csv，在这里有共同点</li>
</ul>
<p>【示例】导出整张表</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mongoexport -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> -c product -o <span class="built_in">test</span>/product.dat</span></span><br><span class="line">2020-09-11T10:44:23.161+0800    connected to: mongodb://127.0.0.1:27017/</span><br><span class="line">2020-09-11T10:44:23.177+0800    exported 11 records</span><br></pre></td></tr></table></figure>
<p>【示例】导出表到 json 文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mongoexport -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> -c product --<span class="built_in">type</span> json -o <span class="built_in">test</span>/product.json</span></span><br><span class="line">2020-09-11T10:49:52.735+0800    connected to: mongodb://127.0.0.1:27017/</span><br><span class="line">2020-09-11T10:49:52.750+0800    exported 11 records</span><br></pre></td></tr></table></figure>
<p>【示例】导出表中部分字段到 csv 文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mongoexport -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> -c product --<span class="built_in">type</span> csv -f name,price -o <span class="built_in">test</span>/product.csv</span></span><br><span class="line">2020-09-11T10:47:33.160+0800    connected to: mongodb://127.0.0.1:27017/</span><br><span class="line">2020-09-11T10:47:33.176+0800    exported 11 records</span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h2>
<ul>
<li><a href="https://www.mongodb.com/" target="_blank" rel="noopener">MongoDB 官网</a></li>
<li><a href="https://github.com/mongodb/mongo" target="_blank" rel="noopener">MongoDB Github</a></li>
<li><a href="https://university.mongodb.com/" target="_blank" rel="noopener">MongoDB 官方免费教程</a></li>
<li><a href="https://www.runoob.com/mongodb/mongodb-tutorial.html" target="_blank" rel="noopener">MongoDB 教程</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/2020/09/09/mongodb-%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/09/09/mongodb-%E6%95%99%E7%A8%8B/" class="post-title-link" itemprop="url">MongoDB 教程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-09 20:47:14" itemprop="dateCreated datePublished" datetime="2020-09-09T20:47:14+08:00">2020-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-14 16:45:53" itemprop="dateModified" datetime="2022-04-14T16:45:53+08:00">2022-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">文档数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2020/09/09/mongodb-%E6%95%99%E7%A8%8B/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/09/09/mongodb-教程/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>487</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mongodb-教程"><a class="markdownIt-Anchor" href="#mongodb-教程"></a> MongoDB 教程</h1>
<blockquote>
<p>MongoDB 是一个基于文档的分布式数据库，由 C++ 语言编写。旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。</p>
<p>MongoDB 是一个介于关系型数据库和非关系型数据库之间的产品。它是非关系数据库当中功能最丰富，最像关系数据库的。它支持的数据结构非常松散，是类似 json 的 bson 格式，因此可以存储比较复杂的数据类型。</p>
<p>MongoDB 最大的特点是它支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。</p>
</blockquote>
<h2 id="内容"><a class="markdownIt-Anchor" href="#内容"></a> 📖 内容</h2>
<h3 id="mongodb-应用指南"><a class="markdownIt-Anchor" href="#mongodb-应用指南"></a> <a href="01.MongoDB%E5%BA%94%E7%94%A8%E6%8C%87%E5%8D%97.md">MongoDB 应用指南</a></h3>
<h3 id="mongodb-的-crud-操作"><a class="markdownIt-Anchor" href="#mongodb-的-crud-操作"></a> <a href="02.MongoDB%E7%9A%84CRUD%E6%93%8D%E4%BD%9C.md">MongoDB 的 CRUD 操作</a></h3>
<h3 id="mongodb-聚合操作"><a class="markdownIt-Anchor" href="#mongodb-聚合操作"></a> <a href="03.MongoDB%E7%9A%84%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C.md">MongoDB 聚合操作</a></h3>
<h3 id="mongodb-事务"><a class="markdownIt-Anchor" href="#mongodb-事务"></a> <a href="04.MongoDB%E4%BA%8B%E5%8A%A1.md">MongoDB 事务</a></h3>
<h3 id="mongodb-建模"><a class="markdownIt-Anchor" href="#mongodb-建模"></a> <a href="05.MongoDB%E5%BB%BA%E6%A8%A1.md">MongoDB 建模</a></h3>
<h3 id="mongodb-建模示例"><a class="markdownIt-Anchor" href="#mongodb-建模示例"></a> <a href="06.MongoDB%E5%BB%BA%E6%A8%A1%E7%A4%BA%E4%BE%8B.md">MongoDB 建模示例</a></h3>
<h3 id="mongodb-索引"><a class="markdownIt-Anchor" href="#mongodb-索引"></a> <a href="07.MongoDB%E7%B4%A2%E5%BC%95.md">MongoDB 索引</a></h3>
<h3 id="mongodb-复制"><a class="markdownIt-Anchor" href="#mongodb-复制"></a> <a href="08.MongoDB%E5%A4%8D%E5%88%B6.md">MongoDB 复制</a></h3>
<h3 id="mongodb-分片"><a class="markdownIt-Anchor" href="#mongodb-分片"></a> <a href="09.MongoDB%E5%88%86%E7%89%87.md">MongoDB 分片</a></h3>
<h3 id="mongodb-运维"><a class="markdownIt-Anchor" href="#mongodb-运维"></a> <a href="20.MongoDB%E8%BF%90%E7%BB%B4.md">MongoDB 运维</a></h3>
<h2 id="资料"><a class="markdownIt-Anchor" href="#资料"></a> 📚 资料</h2>
<ul>
<li><strong>官方</strong>
<ul>
<li><a href="https://www.mongodb.com/" target="_blank" rel="noopener">MongoDB 官网</a></li>
<li><a href="https://github.com/mongodb/mongo" target="_blank" rel="noopener">MongoDB Github</a></li>
<li><a href="https://university.mongodb.com/" target="_blank" rel="noopener">MongoDB 官方免费教程</a></li>
</ul>
</li>
<li><strong>教程</strong>
<ul>
<li><a href="https://www.runoob.com/mongodb/mongodb-tutorial.html" target="_blank" rel="noopener">MongoDB 教程</a></li>
<li><a href="https://time.geekbang.org/course/intro/100040001" target="_blank" rel="noopener">MongoDB 高手课</a></li>
</ul>
</li>
<li><strong>数据</strong>
<ul>
<li><a href="https://github.com/ozlerhakan/mongodb-json-files" target="_blank" rel="noopener">mongodb-json-files</a></li>
</ul>
</li>
<li><strong>文章</strong>
<ul>
<li><a href="https://www.slideshare.net/mdirolf/introduction-to-mongodb" target="_blank" rel="noopener">Introduction to MongoDB</a></li>
</ul>
</li>
</ul>
<h2 id="传送"><a class="markdownIt-Anchor" href="#传送"></a> 🚪 传送</h2>
<p>◾ 🏠 <a href="https://github.com/dunwu/db-tutorial" target="_blank" rel="noopener">DB-TUTORIAL 首页</a> ◾ 🎯 <a href="https://github.com/dunwu/blog" target="_blank" rel="noopener">我的博客</a> ◾</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/2020/09/07/mysql-%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/09/07/mysql-%E9%94%81/" class="post-title-link" itemprop="url">Mysql 锁</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-07 07:54:19" itemprop="dateCreated datePublished" datetime="2020-09-07T07:54:19+08:00">2020-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-14 16:45:53" itemprop="dateModified" datetime="2022-04-14T16:45:53+08:00">2022-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">关系型数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/" itemprop="url" rel="index">
                    <span itemprop="name">Mysql</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2020/09/07/mysql-%E9%94%81/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/09/07/mysql-锁/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mysql-锁"><a class="markdownIt-Anchor" href="#mysql-锁"></a> Mysql 锁</h1>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200716064947.png" alt="img" /></p>
<h2 id="1-悲观锁和乐观锁"><a class="markdownIt-Anchor" href="#1-悲观锁和乐观锁"></a> 1. 悲观锁和乐观锁</h2>
<p>确保在多个事务同时存取数据库中同一数据时不破坏事务的隔离性和统一性以及数据库的统一性，<strong>乐观锁和悲观锁是并发控制主要采用的技术手段。</strong></p>
<ul>
<li><strong><code>悲观锁</code></strong> - 假定会发生并发冲突，屏蔽一切可能违反数据完整性的操作
<ul>
<li>在查询完数据的时候就把事务锁起来，直到提交事务（<code>COMMIT</code>）</li>
<li>实现方式：<strong>使用数据库中的锁机制</strong>。</li>
</ul>
</li>
<li><strong><code>乐观锁</code></strong> - 假设不会发生并发冲突，只在提交操作时检查是否违反数据完整性。
<ul>
<li>在修改数据的时候把事务锁起来，通过 version 的方式来进行锁定</li>
<li>实现方式：<strong>使用 version 版本或者时间戳</strong>。</li>
</ul>
</li>
</ul>
<p>【示例】乐观锁示例</p>
<p>商品 goods 表中有一个字段 status，status 为 1 代表商品未被下单，status 为 2 代表商品已经被下单，那么我们对某个商品下单时必须确保该商品 status 为 1。假设商品的 id 为 1。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> (<span class="keyword">status</span>,<span class="keyword">status</span>,<span class="keyword">version</span>) <span class="keyword">from</span> t_goods <span class="keyword">where</span> <span class="keyword">id</span>=<span class="comment">#&#123;id&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> t_goods</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">status</span>=<span class="number">2</span>,<span class="keyword">version</span>=<span class="keyword">version</span>+<span class="number">1</span></span><br><span class="line"><span class="keyword">where</span> <span class="keyword">id</span>=<span class="comment">#&#123;id&#125; and version=#&#123;version&#125;;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>更详细的乐观锁说可以参考：<a href="https://www.cnblogs.com/laoyeye/p/8097684.html" target="_blank" rel="noopener">使用 mysql 乐观锁解决并发问题</a></p>
</blockquote>
<h2 id="2-表级锁和行级锁"><a class="markdownIt-Anchor" href="#2-表级锁和行级锁"></a> 2. 表级锁和行级锁</h2>
<p>从数据库的锁粒度来看，MySQL 中提供了两种封锁粒度：行级锁和表级锁。</p>
<ul>
<li><strong>表级锁（table lock）</strong> - 锁定整张表。用户对表进行写操作前，需要先获得写锁，这会阻塞其他用户对该表的所有读写操作。只有没有写锁时，其他用户才能获得读锁，读锁之间不会相互阻塞。</li>
<li><strong>行级锁（row lock）</strong> - 锁定指定的行记录。这样其它进程还是可以对同一个表中的其它记录进行操作。</li>
</ul>
<p>应该尽量只锁定需要修改的那部分数据，而不是所有的资源。<strong>锁定的数据量越少，锁竞争的发生频率就越小，系统的并发程度就越高</strong>。但是加锁需要消耗资源，锁的各种操作（包括获取锁、释放锁、以及检查锁状态）都会增加系统开销。因此<strong>锁粒度越小，系统开销就越大</strong>。</p>
<p>在选择锁粒度时，需要在锁开销和并发程度之间做一个权衡。</p>
<p>在 <code>InnoDB</code> 中，<strong>行锁是通过给索引上的索引项加锁来实现的</strong>。<strong>如果没有索引，<code>InnoDB</code> 将会通过隐藏的聚簇索引来对记录加锁</strong>。</p>
<h2 id="3-读写锁"><a class="markdownIt-Anchor" href="#3-读写锁"></a> 3. 读写锁</h2>
<ul>
<li>独享锁（Exclusive），简写为 X 锁，又称写锁。使用方式：<code>SELECT ... FOR UPDATE;</code></li>
<li>共享锁（Shared），简写为 S 锁，又称读锁。使用方式：<code>SELECT ... LOCK IN SHARE MODE;</code></li>
</ul>
<p>写锁和读锁的关系，简言之：<strong>独享锁存在，其他事务就不能做任何操作</strong>。</p>
<p><strong><code>InnoDB</code> 下的行锁、间隙锁、next-key 锁统统属于独享锁</strong>。</p>
<h2 id="4-意向锁"><a class="markdownIt-Anchor" href="#4-意向锁"></a> 4. 意向锁</h2>
<p><strong>当存在表级锁和行级锁的情况下，必须先申请意向锁（表级锁，但不是真的加锁），再获取行级锁</strong>。使用意向锁（Intention Locks）可以更容易地支持多粒度封锁。</p>
<p><strong>意向锁是 <code>InnoDB</code> 自动加的，不需要用户干预</strong>。</p>
<p>在存在行级锁和表级锁的情况下，事务 T 想要对表 A 加 X 锁，就需要先检测是否有其它事务对表 A 或者表 A 中的任意一行加了锁，那么就需要对表 A 的每一行都检测一次，这是非常耗时的。</p>
<p>意向锁规定：</p>
<ul>
<li>IX/IS 是表锁；</li>
<li>X/S 是行锁。</li>
<li>一个事务在获得某个数据行的 S 锁之前，必须先获得表的 IS 锁或者更强的锁；</li>
<li>一个事务在获得某个数据行的 X 锁之前，必须先获得表的 IX 锁。</li>
</ul>
<p>通过引入意向锁，事务 T 想要对表 A 加 X 锁，只需要先检测是否有其它事务对表 A 加了 X/IX/S/IS 锁，如果加了就表示有其它事务正在使用这个表或者表中某一行的锁，因此事务 T 加 X 锁失败。</p>
<p>各种锁的兼容关系如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">-</th>
<th style="text-align:center">X</th>
<th style="text-align:center">IX</th>
<th style="text-align:center">S</th>
<th style="text-align:center">IS</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">X</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">❌</td>
</tr>
<tr>
<td style="text-align:center">IX</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">✔️</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">✔️</td>
</tr>
<tr>
<td style="text-align:center">S</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">✔️</td>
<td style="text-align:center">✔️</td>
</tr>
<tr>
<td style="text-align:center">IS</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">✔️</td>
<td style="text-align:center">✔️</td>
<td style="text-align:center">✔️</td>
</tr>
</tbody>
</table>
<p>解释如下：</p>
<ul>
<li>任意 IS/IX 锁之间都是兼容的，因为它们只表示想要对表加锁，而不是真正加锁；</li>
<li>这里兼容关系针对的是表级锁，而表级的 IX 锁和行级的 X 锁兼容，两个事务可以对两个数据行加 X 锁。（事务 T1 想要对数据行 R1 加 X 锁，事务 T2 想要对同一个表的数据行 R2 加 X 锁，两个事务都需要对该表加 IX 锁，但是 IX 锁是兼容的，并且 IX 锁与行级的 X 锁也是兼容的，因此两个事务都能加锁成功，对同一个表中的两个数据行做修改。）</li>
</ul>
<h2 id="5-mvcc"><a class="markdownIt-Anchor" href="#5-mvcc"></a> 5. MVCC</h2>
<p><strong>多版本并发控制（Multi-Version Concurrency Control, MVCC）可以视为行级锁的一个变种。它在很多情况下都避免了加锁操作，因此开销更低</strong>。不仅是 Mysql，包括 Oracle、PostgreSQL 等其他数据库都实现了各自的 MVCC，实现机制没有统一标准。</p>
<p>MVCC 是 <code>InnoDB</code> 存储引擎实现隔离级别的一种具体方式，<strong>用于实现提交读和可重复读这两种隔离级别</strong>。而未提交读隔离级别总是读取最新的数据行，要求很低，无需使用 MVCC。可串行化隔离级别需要对所有读取的行都加锁，单纯使用 MVCC 无法实现。</p>
<h3 id="51-mvcc-思想"><a class="markdownIt-Anchor" href="#51-mvcc-思想"></a> 5.1. MVCC 思想</h3>
<p>加锁能解决多个事务同时执行时出现的并发一致性问题。在实际场景中读操作往往多于写操作，因此又引入了读写锁来避免不必要的加锁操作，例如读和读没有互斥关系。读写锁中读和写操作仍然是互斥的。</p>
<p>MVCC 的思想是：</p>
<ul>
<li><strong>保存数据在某个时间点的快照，写操作（DELETE、INSERT、UPDATE）更新最新的版本快照；而读操作去读旧版本快照，没有互斥关系</strong>。这一点和 <code>CopyOnWrite</code> 类似。</li>
<li>脏读和不可重复读最根本的原因是<strong>事务读取到其它事务未提交的修改</strong>。在事务进行读取操作时，为了解决脏读和不可重复读问题，<strong>MVCC 规定只能读取已经提交的快照</strong>。当然一个事务可以读取自身未提交的快照，这不算是脏读。</li>
</ul>
<h3 id="52-版本号"><a class="markdownIt-Anchor" href="#52-版本号"></a> 5.2. 版本号</h3>
<p>InnoDB 的 MVCC 实现是：在每行记录后面保存两个隐藏列，一个列保存行的创建时间，另一个列保存行的过期时间（这里的时间是指系统版本号）。每开始一个新事务，系统版本号会自动递增，事务开始时刻的系统版本号会作为事务的版本号，用来和查询到的每行记录的版本号进行比较。</p>
<ul>
<li>系统版本号 <code>SYS_ID</code>：是一个递增的数字，每开始一个新的事务，系统版本号就会自动递增。</li>
<li>事务版本号 <code>TRX_ID</code> ：事务开始时的系统版本号。</li>
</ul>
<h3 id="53-undo-日志"><a class="markdownIt-Anchor" href="#53-undo-日志"></a> 5.3. Undo 日志</h3>
<p>MVCC 的多版本指的是多个版本的快照，快照存储在 Undo 日志中，该日志通过回滚指针 <code>ROLL_PTR</code> 把一个数据行的所有快照连接起来。</p>
<p>例如在 MySQL 创建一个表 t，包含主键 id 和一个字段 x。我们先插入一个数据行，然后对该数据行执行两次更新操作。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t(<span class="keyword">id</span>, x) <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">"a"</span>);</span><br><span class="line"><span class="keyword">UPDATE</span> t <span class="keyword">SET</span> x=<span class="string">"b"</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> t <span class="keyword">SET</span> x=<span class="string">"c"</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>因为没有使用 <code>START TRANSACTION</code> 将上面的操作当成一个事务来执行，根据 MySQL 的 <code>AUTOCOMMIT</code> 机制，每个操作都会被当成一个事务来执行，所以上面的操作总共涉及到三个事务。快照中除了记录事务版本号 TRX_ID 和操作之外，还记录了一个 bit 的 DEL 字段，用于标记是否被删除。</p>
<p><code>INSERT</code>、<code>UPDATE</code>、<code>DELETE</code> 操作会创建一个日志，并将事务版本号 <code>TRX_ID</code> 写入。<code>DELETE</code> 可以看成是一个特殊的 <code>UPDATE</code>，还会额外将 DEL 字段设置为 1。</p>
<h3 id="54-readview"><a class="markdownIt-Anchor" href="#54-readview"></a> 5.4. ReadView</h3>
<p>MVCC 维护了一个一致性读视图 <code>consistent read view</code> ，主要包含了当前系统<strong>未提交的事务列表</strong> <code>TRX_IDs {TRX_ID_1, TRX_ID_2, ...}</code>，还有该列表的最小值 <code>TRX_ID_MIN</code> 和 <code>TRX_ID_MAX</code>。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200715135809.png" alt="img" /></p>
<p>这样，对于当前事务的启动瞬间来说，一个数据版本的 row trx_id，有以下几种可能：</p>
<ol>
<li>如果落在绿色部分，表示这个版本是已提交的事务或者是当前事务自己生成的，这个数据是可见的；</li>
<li>如果落在红色部分，表示这个版本是由将来启动的事务生成的，是肯定不可见的；</li>
<li>如果落在黄色部分，那就包括两种情况<br />
a. 若 row trx_id 在数组中，表示这个版本是由还没提交的事务生成的，不可见；<br />
b. 若 row trx_id 不在数组中，表示这个版本是已经提交了的事务生成的，可见。</li>
</ol>
<p>在进行 <code>SELECT</code> 操作时，根据数据行快照的 <code>TRX_ID</code> 与 <code>TRX_ID_MIN</code> 和 <code>TRX_ID_MAX</code> 之间的关系，从而判断数据行快照是否可以使用：</p>
<ul>
<li><code>TRX_ID</code> &lt; <code>TRX_ID_MIN</code>，表示该数据行快照时在当前所有未提交事务之前进行更改的，因此可以使用。</li>
<li><code>TRX_ID</code> &gt; <code>TRX_ID_MAX</code>，表示该数据行快照是在事务启动之后被更改的，因此不可使用。</li>
<li><code>TRX_ID_MIN</code> &lt;= <code>TRX_ID</code> &lt;= <code>TRX_ID_MAX</code>，需要根据隔离级别再进行判断：
<ul>
<li>提交读：如果 <code>TRX_ID</code> 在 <code>TRX_IDs</code> 列表中，表示该数据行快照对应的事务还未提交，则该快照不可使用。否则表示已经提交，可以使用。</li>
<li>可重复读：都不可以使用。因为如果可以使用的话，那么其它事务也可以读到这个数据行快照并进行修改，那么当前事务再去读这个数据行得到的值就会发生改变，也就是出现了不可重复读问题。</li>
</ul>
</li>
</ul>
<p>在数据行快照不可使用的情况下，需要沿着 Undo Log 的回滚指针 ROLL_PTR 找到下一个快照，再进行上面的判断。</p>
<h3 id="55-快照读与当前读"><a class="markdownIt-Anchor" href="#55-快照读与当前读"></a> 5.5. 快照读与当前读</h3>
<p>快照读</p>
<p>MVCC 的 SELECT 操作是快照中的数据，不需要进行加锁操作。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">table</span> ...;</span><br></pre></td></tr></table></figure>
<p>当前读</p>
<p>MVCC 其它会对数据库进行修改的操作（INSERT、UPDATE、DELETE）需要进行加锁操作，从而读取最新的数据。可以看到 MVCC 并不是完全不用加锁，而只是避免了 SELECT 的加锁操作。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span>;</span><br><span class="line"><span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="keyword">DELETE</span>;</span><br></pre></td></tr></table></figure>
<p>在进行 SELECT 操作时，可以强制指定进行加锁操作。以下第一个语句需要加 S 锁，第二个需要加 X 锁。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> ? <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> ? <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>
<h2 id="6-行锁"><a class="markdownIt-Anchor" href="#6-行锁"></a> 6. 行锁</h2>
<p>行锁的具体实现算法有三种：record lock、gap lock 以及 next-key lock。</p>
<ul>
<li><code>Record Lock</code> - <strong>行锁对索引项加锁，若没有索引则使用表锁</strong>。</li>
<li><code>Gap Lock</code> - <strong>对索引项之间的间隙加锁</strong>。锁定索引之间的间隙，但是不包含索引本身。例如当一个事务执行以下语句，其它事务就不能在 t.c 中插入 15：<code>SELECT c FROM t WHERE c BETWEEN 10 and 20 FOR UPDATE;</code>。在 MySQL 中，gap lock 默认是开启的，即 <code>innodb_locks_unsafe_for_binlog</code> 参数值是 disable 的，且 MySQL 中默认的是 RR 事务隔离级别。</li>
<li><code>Next-key lock</code> -它是 <code>Record Lock</code> 和 <code>Gap Lock</code> 的结合，不仅锁定一个记录上的索引，也锁定索引之间的间隙。它锁定一个前开后闭区间。</li>
</ul>
<p>只在可重复读或以上隔离级别下的特定操作才会取得 gap lock 或 next-key lock。在 <code>Select</code>、<code>Update</code> 和 <code>Delete</code> 时，除了基于唯一索引的查询之外，其它索引查询时都会获取 gap lock 或 next-key lock，即锁住其扫描的范围。主键索引也属于唯一索引，所以主键索引是不会使用 gap lock 或 next-key lock。</p>
<p>MVCC 不能解决幻读问题，<strong>Next-Key 锁就是为了解决幻读问题</strong>。在可重复读（<code>REPEATABLE READ</code>）隔离级别下，使用 <strong>MVCC + Next-Key 锁</strong> 可以解决幻读问题。</p>
<p>索引分为主键索引和非主键索引两种，如果一条 SQL 语句操作了主键索引，MySQL 就会锁定这条主键索引；如果一条语句操作了非主键索引，MySQL 会先锁定该非主键索引，再锁定相关的主键索引。在 <code>UPDATE</code>、<code>DELETE</code> 操作时，MySQL 不仅锁定 <code>WHERE</code> 条件扫描过的所有索引记录，而且会锁定相邻的键值，即所谓的 <code>next-key lock</code>。</p>
<p>当两个事务同时执行，一个锁住了主键索引，在等待其他相关索引。另一个锁定了非主键索引，在等待主键索引。这样就会发生死锁。发生死锁后，<code>InnoDB</code> 一般都可以检测到，并使一个事务释放锁回退，另一个获取锁完成事务。</p>
<h2 id="7-参考资料"><a class="markdownIt-Anchor" href="#7-参考资料"></a> 7. 参考资料</h2>
<ul>
<li><a href="https://book.douban.com/subject/23008813/" target="_blank" rel="noopener">《高性能 MySQL》</a></li>
<li><a href="https://time.geekbang.org/column/intro/100028001" target="_blank" rel="noopener">《Java 性能调优实战》</a></li>
<li><a href="https://github.com/CyC2018/Interview-Notebook/blob/master/notes/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86.md" target="_blank" rel="noopener">数据库系统原理</a></li>
<li><a href="https://juejin.im/post/5b55b842f265da0f9e589e79" target="_blank" rel="noopener">数据库两大神器【索引和锁】</a></li>
<li><a href="https://www.cnblogs.com/laoyeye/p/8097684.html" target="_blank" rel="noopener">使用 mysql 乐观锁解决并发问题</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/2020/09/07/mongodb-%E5%BA%94%E7%94%A8%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/09/07/mongodb-%E5%BA%94%E7%94%A8%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">MongoDB 应用指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-07 07:54:19" itemprop="dateCreated datePublished" datetime="2020-09-07T07:54:19+08:00">2020-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-14 16:45:53" itemprop="dateModified" datetime="2022-04-14T16:45:53+08:00">2022-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">文档数据库</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2020/09/07/mongodb-%E5%BA%94%E7%94%A8%E6%8C%87%E5%8D%97/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/09/07/mongodb-应用指南/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mongodb-应用指南"><a class="markdownIt-Anchor" href="#mongodb-应用指南"></a> MongoDB 应用指南</h1>
<h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2>
<p>MongoDB 是一个基于分布式文件存储的数据库。由 C++ 语言编写。旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。</p>
<p>MongoDB 将数据存储为一个文档，数据结构由键值(key=&gt;value)对组成。MongoDB 文档类似于 JSON 对象。字段值可以包含其他文档，数组及文档数组。</p>
<h3 id="mongodb-发展"><a class="markdownIt-Anchor" href="#mongodb-发展"></a> MongoDB 发展</h3>
<ul>
<li>1.x - 支持复制和分片</li>
<li>2.x - 更丰富的数据库功能</li>
<li>3.x - WiredTiger 和周边生态</li>
<li>4.x - 支持分布式事务</li>
</ul>
<h3 id="mongodb-和-rdbms"><a class="markdownIt-Anchor" href="#mongodb-和-rdbms"></a> MongoDB 和 RDBMS</h3>
<table>
<thead>
<tr>
<th>特性</th>
<th>MongoDB</th>
<th>RDBMS</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据模型</td>
<td>文档模型</td>
<td>关系型</td>
</tr>
<tr>
<td>CRUD 操作</td>
<td>MQL/SQL</td>
<td>SQL</td>
</tr>
<tr>
<td>高可用</td>
<td>复制集</td>
<td>集群模式</td>
</tr>
<tr>
<td>扩展性</td>
<td>支持分片</td>
<td>数据分区</td>
</tr>
<tr>
<td>扩繁方式</td>
<td>垂直扩展+水平扩展</td>
<td>垂直扩展</td>
</tr>
<tr>
<td>索引类型</td>
<td>B 树、全文索引、地理位置索引、多键索引、TTL 索引</td>
<td>B 树</td>
</tr>
<tr>
<td>数据容量</td>
<td>没有理论上限</td>
<td>千万、亿</td>
</tr>
</tbody>
</table>
<h3 id="mongodb-特性"><a class="markdownIt-Anchor" href="#mongodb-特性"></a> MongoDB 特性</h3>
<ul>
<li>数据是 JSON 结构
<ul>
<li>支持结构化、半结构化数据模型</li>
<li>可以动态响应结构变化</li>
</ul>
</li>
<li>通过副本机制提供高可用</li>
<li>通过分片提供扩容能力</li>
</ul>
<h2 id="mongodb-概念"><a class="markdownIt-Anchor" href="#mongodb-概念"></a> MongoDB 概念</h2>
<table>
<thead>
<tr>
<th style="text-align:left">SQL 术语/概念</th>
<th style="text-align:left">MongoDB 术语/概念</th>
<th style="text-align:left">解释/说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">database</td>
<td style="text-align:left">database</td>
<td style="text-align:left">数据库</td>
</tr>
<tr>
<td style="text-align:left">table</td>
<td style="text-align:left">collection</td>
<td style="text-align:left">数据库表/集合</td>
</tr>
<tr>
<td style="text-align:left">row</td>
<td style="text-align:left">document</td>
<td style="text-align:left">数据记录行/文档</td>
</tr>
<tr>
<td style="text-align:left">column</td>
<td style="text-align:left">field</td>
<td style="text-align:left">数据字段/域</td>
</tr>
<tr>
<td style="text-align:left">index</td>
<td style="text-align:left">index</td>
<td style="text-align:left">索引</td>
</tr>
<tr>
<td style="text-align:left">table joins</td>
<td style="text-align:left"></td>
<td style="text-align:left">表连接,MongoDB 不支持</td>
</tr>
<tr>
<td style="text-align:left">primary key</td>
<td style="text-align:left">primary key</td>
<td style="text-align:left">主键,MongoDB 自动将_id 字段设置为主键</td>
</tr>
</tbody>
</table>
<h3 id="数据库"><a class="markdownIt-Anchor" href="#数据库"></a> 数据库</h3>
<p>一个 MongoDB 中可以建立多个数据库。</p>
<p>MongoDB 的默认数据库为&quot;db&quot;，该数据库存储在 data 目录中。</p>
<p>MongoDB 的单个实例可以容纳多个独立的数据库，每一个都有自己的集合和权限，不同的数据库也放置在不同的文件中。</p>
<p><strong>&quot;show dbs&quot;</strong> 命令可以显示所有数据的列表。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./mongo</span></span><br><span class="line">MongoDBshell version: 3.0.6</span><br><span class="line">connecting to: test</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> show dbs</span></span><br><span class="line">local  0.078GB</span><br><span class="line">test   0.078GB</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>
<p>执行 <strong>“db”</strong> 命令可以显示当前数据库对象或集合。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./mongo</span></span><br><span class="line">MongoDBshell version: 3.0.6</span><br><span class="line">connecting to: test</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> db</span></span><br><span class="line">test</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>
<p>运行&quot;use&quot;命令，可以连接到一个指定的数据库。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> use <span class="built_in">local</span></span></span><br><span class="line">switched to db local</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> db</span></span><br><span class="line">local</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>
<p>数据库也通过名字来标识。数据库名可以是满足以下条件的任意 UTF-8 字符串。</p>
<ul>
<li>不能是空字符串（&quot;&quot;)。</li>
<li>不得含有 ’ '（空格)、<code>.</code>、<code>\$</code>、<code>/</code>、<code>\</code>和 <code>\0</code> (空字符)。</li>
<li>应全部小写。</li>
<li>最多 64 字节。</li>
</ul>
<p>有一些数据库名是保留的，可以直接访问这些有特殊作用的数据库。</p>
<ul>
<li><strong>admin</strong>：从权限的角度来看，这是&quot;root&quot;数据库。要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限。一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器。</li>
<li><strong>local</strong>：这个数据永远不会被复制，可以用来存储限于本地单台服务器的任意集合</li>
<li><strong>config</strong>：当 Mongo 用于分片设置时，config 数据库在内部使用，用于保存分片的相关信息。</li>
</ul>
<h3 id="文档"><a class="markdownIt-Anchor" href="#文档"></a> 文档</h3>
<p>文档是一组键值(key-value)对(即 BSON)。MongoDB 的文档不需要设置相同的字段，并且相同的字段不需要相同的数据类型，这与关系型数据库有很大的区别，也是 MongoDB 非常突出的特点。</p>
<p>需要注意的是：</p>
<ul>
<li>文档中的键/值对是有序的。</li>
<li>文档中的值不仅可以是在双引号里面的字符串，还可以是其他几种数据类型（甚至可以是整个嵌入的文档)。</li>
<li>MongoDB 区分类型和大小写。</li>
<li>MongoDB 的文档不能有重复的键。</li>
<li>文档的键是字符串。除了少数例外情况，键可以使用任意 UTF-8 字符。</li>
</ul>
<p>文档键命名规范：</p>
<ul>
<li>键不能含有 <code>\0</code> (空字符)。这个字符用来表示键的结尾。</li>
<li><code>.</code> 和 <code>$</code> 有特别的意义，只有在特定环境下才能使用。</li>
<li>以下划线 <code>_</code> 开头的键是保留的(不是严格要求的)。</li>
</ul>
<h3 id="集合"><a class="markdownIt-Anchor" href="#集合"></a> 集合</h3>
<p>集合就是 MongoDB 文档组，类似于 RDBMS （关系数据库管理系统：Relational Database Management System)中的表格。</p>
<p>集合存在于数据库中，集合没有固定的结构，这意味着你在对集合可以插入不同格式和类型的数据，但通常情况下我们插入集合的数据都会有一定的关联性。</p>
<p>合法的集合名：</p>
<ul>
<li>集合名不能是空字符串&quot;&quot;。</li>
<li>集合名不能含有 <code>\0</code> 字符（空字符)，这个字符表示集合名的结尾。</li>
<li>集合名不能以&quot;system.&quot;开头，这是为系统集合保留的前缀。</li>
<li>用户创建的集合名字不能含有保留字符。有些驱动程序的确支持在集合名里面包含，这是因为某些系统生成的集合中包含该字符。除非你要访问这种系统创建的集合，否则千万不要在名字里出现 <code>$</code>。</li>
</ul>
<h3 id="元数据"><a class="markdownIt-Anchor" href="#元数据"></a> 元数据</h3>
<p>数据库的信息是存储在集合中。它们使用了系统的命名空间：<code>dbname.system.*</code></p>
<p>在 MongoDB 数据库中名字空间 <code>&lt;dbname&gt;.system.*</code> 是包含多种系统信息的特殊集合(Collection)，如下:</p>
<table>
<thead>
<tr>
<th style="text-align:left">集合命名空间</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">dbname.system.namespaces</td>
<td style="text-align:left">列出所有名字空间。</td>
</tr>
<tr>
<td style="text-align:left">dbname.system.indexes</td>
<td style="text-align:left">列出所有索引。</td>
</tr>
<tr>
<td style="text-align:left">dbname.system.profile</td>
<td style="text-align:left">包含数据库概要(profile)信息。</td>
</tr>
<tr>
<td style="text-align:left">dbname.system.users</td>
<td style="text-align:left">列出所有可访问数据库的用户。</td>
</tr>
<tr>
<td style="text-align:left">dbname.local.sources</td>
<td style="text-align:left">包含复制对端（slave）的服务器信息和状态。</td>
</tr>
</tbody>
</table>
<p>对于修改系统集合中的对象有如下限制。</p>
<p>在 <code>system.indexes</code> 插入数据，可以创建索引。但除此之外该表信息是不可变的(特殊的 drop index 命令将自动更新相关信息)。<code>system.users</code> 是可修改的。<code>system.profile</code> 是可删除的。</p>
<h2 id="mongodb-数据类型"><a class="markdownIt-Anchor" href="#mongodb-数据类型"></a> MongoDB 数据类型</h2>
<table>
<thead>
<tr>
<th style="text-align:left">数据类型</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">String</td>
<td style="text-align:left">字符串。存储数据常用的数据类型。在 MongoDB 中，UTF-8 编码的字符串才是合法的。</td>
</tr>
<tr>
<td style="text-align:left">Integer</td>
<td style="text-align:left">整型数值。用于存储数值。根据你所采用的服务器，可分为 32 位或 64 位。</td>
</tr>
<tr>
<td style="text-align:left">Boolean</td>
<td style="text-align:left">布尔值。用于存储布尔值（真/假）。</td>
</tr>
<tr>
<td style="text-align:left">Double</td>
<td style="text-align:left">双精度浮点值。用于存储浮点值。</td>
</tr>
<tr>
<td style="text-align:left">Min/Max keys</td>
<td style="text-align:left">将一个值与 BSON（二进制的 JSON）元素的最低值和最高值相对比。</td>
</tr>
<tr>
<td style="text-align:left">Array</td>
<td style="text-align:left">用于将数组或列表或多个值存储为一个键。</td>
</tr>
<tr>
<td style="text-align:left">Timestamp</td>
<td style="text-align:left">时间戳。记录文档修改或添加的具体时间。</td>
</tr>
<tr>
<td style="text-align:left">Object</td>
<td style="text-align:left">用于内嵌文档。</td>
</tr>
<tr>
<td style="text-align:left">Null</td>
<td style="text-align:left">用于创建空值。</td>
</tr>
<tr>
<td style="text-align:left">Symbol</td>
<td style="text-align:left">符号。该数据类型基本上等同于字符串类型，但不同的是，它一般用于采用特殊符号类型的语言。</td>
</tr>
<tr>
<td style="text-align:left">Date</td>
<td style="text-align:left">日期时间。用 UNIX 时间格式来存储当前日期或时间。你可以指定自己的日期时间：创建 Date 对象，传入年月日信息。</td>
</tr>
<tr>
<td style="text-align:left">Object ID</td>
<td style="text-align:left">对象 ID。用于创建文档的 ID。</td>
</tr>
<tr>
<td style="text-align:left">Binary Data</td>
<td style="text-align:left">二进制数据。用于存储二进制数据。</td>
</tr>
<tr>
<td style="text-align:left">Code</td>
<td style="text-align:left">代码类型。用于在文档中存储 JavaScript 代码。</td>
</tr>
<tr>
<td style="text-align:left">Regular expression</td>
<td style="text-align:left">正则表达式类型。用于存储正则表达式。</td>
</tr>
</tbody>
</table>
<h2 id="mongodb-crud"><a class="markdownIt-Anchor" href="#mongodb-crud"></a> MongoDB CRUD</h2>
<h3 id="数据库操作"><a class="markdownIt-Anchor" href="#数据库操作"></a> 数据库操作</h3>
<h4 id="查看所有数据库"><a class="markdownIt-Anchor" href="#查看所有数据库"></a> 查看所有数据库</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">show dbs</span><br></pre></td></tr></table></figure>
<h4 id="创建数据库"><a class="markdownIt-Anchor" href="#创建数据库"></a> 创建数据库</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">use &lt;database&gt;</span><br></pre></td></tr></table></figure>
<p>如果数据库不存在，则创建数据库，否则切换到指定数据库。</p>
<p>【示例】创建数据库，并插入一条数据</p>
<p>刚创建的数据库 test 并不在数据库的列表中， 要显示它，需要插入一些数据</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> use <span class="built_in">test</span></span></span><br><span class="line">switched to db test</span><br><span class="line"><span class="meta">&gt;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> show dbs</span></span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local   0.000GB</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> db.test.insert(&#123;<span class="string">"name"</span>:<span class="string">"mongodb"</span>&#125;)</span></span><br><span class="line">WriteResult(&#123; "nInserted" : 1 &#125;)</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> show dbs</span></span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local   0.000GB</span><br><span class="line">test    0.000GB</span><br></pre></td></tr></table></figure>
<h4 id="删除数据库"><a class="markdownIt-Anchor" href="#删除数据库"></a> 删除数据库</h4>
<p>删除当前数据库</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.dropDatabase()</span><br></pre></td></tr></table></figure>
<h3 id="集合操作"><a class="markdownIt-Anchor" href="#集合操作"></a> 集合操作</h3>
<h4 id="查看集合"><a class="markdownIt-Anchor" href="#查看集合"></a> 查看集合</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">show collections</span><br></pre></td></tr></table></figure>
<h4 id="创建集合"><a class="markdownIt-Anchor" href="#创建集合"></a> 创建集合</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.createCollection(name, options)</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>name: 要创建的集合名称</li>
<li>options: 可选参数, 指定有关内存大小及索引的选项</li>
</ul>
<p>options 可以是如下参数：</p>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">类型</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">capped</td>
<td style="text-align:left">布尔</td>
<td style="text-align:left">（可选）如果为 true，则创建固定集合。固定集合是指有着固定大小的集合，当达到最大值时，它会自动覆盖最早的文档。 <strong>当该值为 true 时，必须指定 size 参数。</strong></td>
</tr>
<tr>
<td style="text-align:left">autoIndexId</td>
<td style="text-align:left">布尔</td>
<td style="text-align:left">3.2 之后不再支持该参数。（可选）如为 true，自动在 _id 字段创建索引。默认为 false。</td>
</tr>
<tr>
<td style="text-align:left">size</td>
<td style="text-align:left">数值</td>
<td style="text-align:left">（可选）为固定集合指定一个最大值，即字节数。 <strong>如果 capped 为 true，也需要指定该字段。</strong></td>
</tr>
<tr>
<td style="text-align:left">max</td>
<td style="text-align:left">数值</td>
<td style="text-align:left">（可选）指定固定集合中包含文档的最大数量。</td>
</tr>
</tbody>
</table>
<p>在插入文档时，MongoDB 首先检查固定集合的 size 字段，然后检查 max 字段。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> db.createCollection(<span class="string">"collection"</span>)</span></span><br><span class="line">&#123; "ok" : 1 &#125;</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> show collections</span></span><br><span class="line">collection</span><br></pre></td></tr></table></figure>
<h4 id="删除集合"><a class="markdownIt-Anchor" href="#删除集合"></a> 删除集合</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> db.collection.drop()</span></span><br><span class="line">true</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> show collections</span></span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="插入文档操作"><a class="markdownIt-Anchor" href="#插入文档操作"></a> 插入文档操作</h3>
<p>MongoDB 使用 insert() 方法完成插入操作。</p>
<p><strong>语法格式</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 插入单条记录</span></span><br><span class="line">db.&lt;集合&gt;.insertOne(&lt;JSON&gt;)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 插入多条记录</span></span><br><span class="line">db.&lt;集合&gt;.insertMany([&lt;JSON 1&gt;, &lt;JSON 2&gt;, ..., &lt;JSON N&gt;])</span><br></pre></td></tr></table></figure>
<p>【示例】insertOne</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> db.color.insertOne(&#123;name: <span class="string">"red"</span>&#125;)</span></span><br><span class="line">&#123;</span><br><span class="line">        "acknowledged" : true,</span><br><span class="line">        "insertedId" : ObjectId("5f533ae4e8f16647950fdf43")</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>【示例】insertMany</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> db.color.insertMany([</span></span><br><span class="line">  &#123;</span><br><span class="line">    "name": "yellow"</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    "name": "blue"</span><br><span class="line">  &#125;</span><br><span class="line">])</span><br><span class="line">&#123;</span><br><span class="line">        "acknowledged" : true,</span><br><span class="line">        "insertedIds" : [</span><br><span class="line">                ObjectId("5f533bcae8f16647950fdf44"),</span><br><span class="line">                ObjectId("5f533bcae8f16647950fdf45")</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="查询文档操作"><a class="markdownIt-Anchor" href="#查询文档操作"></a> 查询文档操作</h3>
<p>MongoDB 使用 <code>find()</code> 方法完成查询文档操作。</p>
<p><strong>语法格式</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.&lt;集合&gt;.find(&lt;JSON&gt;)</span><br></pre></td></tr></table></figure>
<p>查询条件也是 json 形式，如果不设置查询条件，即为全量查询。</p>
<h4 id="查询条件"><a class="markdownIt-Anchor" href="#查询条件"></a> 查询条件</h4>
<table>
<thead>
<tr>
<th style="text-align:left">操作</th>
<th style="text-align:left">格式</th>
<th style="text-align:left">范例</th>
<th style="text-align:left">RDBMS 中的类似语句</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">等于</td>
<td style="text-align:left"><code>{&lt;key&gt;:&lt;value&gt;</code>}</td>
<td style="text-align:left"><code>db.book.find({&quot;pageCount&quot;: {$eq: 0}})</code></td>
<td style="text-align:left"><code>where pageCount = 0</code></td>
</tr>
<tr>
<td style="text-align:left">不等于</td>
<td style="text-align:left"><code>{&lt;key&gt;:{$ne:&lt;value&gt;}}</code></td>
<td style="text-align:left"><code>db.book.find({&quot;pageCount&quot;: {$ne: 0}})</code></td>
<td style="text-align:left"><code>where likes != 50</code></td>
</tr>
<tr>
<td style="text-align:left">大于</td>
<td style="text-align:left"><code>{&lt;key&gt;:{$gt:&lt;value&gt;}}</code></td>
<td style="text-align:left"><code>db.book.find({&quot;pageCount&quot;: {$gt: 0}})</code></td>
<td style="text-align:left"><code>where likes &gt; 50</code></td>
</tr>
<tr>
<td style="text-align:left"><code>{&lt;key&gt;:{$gt:&lt;value&gt;}}</code></td>
<td style="text-align:left"><code>db.book.find({&quot;pageCount&quot;: {$gt: 0}})</code></td>
<td style="text-align:left"><code>where likes &gt; 50</code></td>
<td style="text-align:left">大于或等于</td>
</tr>
<tr>
<td style="text-align:left">小于</td>
<td style="text-align:left"><code>{&lt;key&gt;:{$lt:&lt;value&gt;}}</code></td>
<td style="text-align:left"><code>db.book.find({&quot;pageCount&quot;: {$lt: 200}})</code></td>
<td style="text-align:left"><code>where likes &lt; 50</code></td>
</tr>
<tr>
<td style="text-align:left">小于或等于</td>
<td style="text-align:left"><code>{&lt;key&gt;:{$lte:&lt;value&gt;}}</code></td>
<td style="text-align:left"><code>db.book.find({&quot;pageCount&quot;: {$lte: 200}})</code></td>
<td style="text-align:left"><code>where likes &lt;= 50</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>说明：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">eq  --------  equal  =</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ne ----------- not equal  !=</span></span><br><span class="line"><span class="meta">$</span><span class="bash">gt -------- greater than  &gt;</span></span><br><span class="line"><span class="meta">$</span><span class="bash">gte --------- gt equal  &gt;=</span></span><br><span class="line"><span class="meta">$</span><span class="bash">lt -------- less than  &lt;</span></span><br><span class="line"><span class="meta">$</span><span class="bash">lte --------- lt equal  &lt;=</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>【示例】</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 统计匹配查询条件的记录数</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> db.book.find(&#123;<span class="string">"status"</span>: <span class="string">"MEAP"</span>&#125;).count()</span></span><br><span class="line">68</span><br></pre></td></tr></table></figure>
<h4 id="查询逻辑条件"><a class="markdownIt-Anchor" href="#查询逻辑条件"></a> 查询逻辑条件</h4>
<p>（1）and 条件</p>
<p>MongoDB 的 find() 方法可以传入多个键(key)，每个键(key)以逗号隔开，即常规 SQL 的 AND 条件。</p>
<p>语法格式如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> db.col.find(&#123;key1:value1, key2:value2&#125;).pretty()</span></span><br></pre></td></tr></table></figure>
<p>（2）or 条件</p>
<p>MongoDB OR 条件语句使用了关键字 <strong>$or</strong>,语法格式如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">db.col.find(</span></span><br><span class="line">   &#123;</span><br><span class="line">      $or: [</span><br><span class="line">         &#123;key1: value1&#125;, &#123;key2:value2&#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">).pretty()</span><br></pre></td></tr></table></figure>
<h4 id="模糊查询"><a class="markdownIt-Anchor" href="#模糊查询"></a> 模糊查询</h4>
<p>查询 title 包含&quot;教&quot;字的文档：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.col.find(&#123; title: /教/ &#125;)</span><br></pre></td></tr></table></figure>
<p>查询 title 字段以&quot;教&quot;字开头的文档：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.col.find(&#123; title: /^教/ &#125;)</span><br></pre></td></tr></table></figure>
<p>查询 titl e 字段以&quot;教&quot;字结尾的文档：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.col.find(&#123; title: /教$/ &#125;)</span><br></pre></td></tr></table></figure>
<h4 id="limit-方法"><a class="markdownIt-Anchor" href="#limit-方法"></a> Limit() 方法</h4>
<p>如果你需要在 MongoDB 中读取指定数量的数据记录，可以使用 MongoDB 的 Limit 方法，limit()方法接受一个数字参数，该参数指定从 MongoDB 中读取的记录条数。</p>
<p>limit()方法基本语法如下所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">db.COLLECTION_NAME.find().<span class="built_in">limit</span>(NUMBER)</span></span><br></pre></td></tr></table></figure>
<h4 id="skip-方法"><a class="markdownIt-Anchor" href="#skip-方法"></a> Skip() 方法</h4>
<p>我们除了可以使用 limit()方法来读取指定数量的数据外，还可以使用 skip()方法来跳过指定数量的数据，skip 方法同样接受一个数字参数作为跳过的记录条数。</p>
<p>skip() 方法脚本语法格式如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">db.COLLECTION_NAME.find().<span class="built_in">limit</span>(NUMBER).skip(NUMBER)</span></span><br></pre></td></tr></table></figure>
<h4 id="sort-方法"><a class="markdownIt-Anchor" href="#sort-方法"></a> Sort() 方法</h4>
<p>在 MongoDB 中使用 sort() 方法对数据进行排序，sort() 方法可以通过参数指定排序的字段，并使用 1 和 -1 来指定排序的方式，其中 1 为升序排列，而 -1 是用于降序排列。</p>
<p>sort()方法基本语法如下所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">db.COLLECTION_NAME.find().sort(&#123;KEY:1&#125;)</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：skip(), limilt(), sort()三个放在一起执行的时候，执行的顺序是先 sort(), 然后是 skip()，最后是显示的 limit()。</p>
</blockquote>
<h3 id="更新文档操作"><a class="markdownIt-Anchor" href="#更新文档操作"></a> 更新文档操作</h3>
<p>update() 方法用于更新已存在的文档。语法格式如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.collection.update(</span><br><span class="line">   &lt;query&gt;,</span><br><span class="line">   &lt;update&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">     upsert: &lt;boolean&gt;,</span><br><span class="line">     multi: &lt;boolean&gt;,</span><br><span class="line">     writeConcern: &lt;document&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>参数说明：</strong></p>
<ul>
<li><strong>query</strong> : update 的查询条件，类似 sql update 查询内 where 后面的。</li>
<li><strong>update</strong> : update 的对象和一些更新的操作符（如<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">,</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3em;vertical-align:-0.19444em;"></span><span class="mpunct">,</span></span></span></span>inc…）等，也可以理解为 sql update 查询内 set 后面的</li>
<li><strong>upsert</strong> : 可选，这个参数的意思是，如果不存在 update 的记录，是否插入 objNew,true 为插入，默认是 false，不插入。</li>
<li><strong>multi</strong> : 可选，mongodb 默认是 false,只更新找到的第一条记录，如果这个参数为 true,就把按条件查出来多条记录全部更新。</li>
<li><strong>writeConcern</strong> :可选，抛出异常的级别。</li>
</ul>
<p>【示例】更新文档</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.collection.update(&#123; title: 'MongoDB 教程' &#125;, &#123; $set: &#123; title: 'MongoDB' &#125; &#125;)</span><br></pre></td></tr></table></figure>
<p>【示例】更新多条相同文档</p>
<p>以上语句只会修改第一条发现的文档，如果你要修改多条相同的文档，则需要设置 multi 参数为 true。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.collection.update(</span><br><span class="line">  &#123; title: 'MongoDB 教程' &#125;,</span><br><span class="line">  &#123; $set: &#123; title: 'MongoDB' &#125; &#125;,</span><br><span class="line">  &#123; multi: true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>【示例】更多实例</p>
<p>只更新第一条记录：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.collection.update(&#123; count: &#123; $gt: 1 &#125; &#125;, &#123; $set: &#123; test2: 'OK' &#125; &#125;)</span><br></pre></td></tr></table></figure>
<p>全部更新：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.collection.update(</span><br><span class="line">  &#123; count: &#123; $gt: 3 &#125; &#125;,</span><br><span class="line">  &#123; $set: &#123; test2: 'OK' &#125; &#125;,</span><br><span class="line">  false,</span><br><span class="line">  true</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>只添加第一条：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.collection.update(</span><br><span class="line">  &#123; count: &#123; $gt: 4 &#125; &#125;,</span><br><span class="line">  &#123; $set: &#123; test5: 'OK' &#125; &#125;,</span><br><span class="line">  true,</span><br><span class="line">  false</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>全部添加进去:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.collection.update(</span><br><span class="line">  &#123; count: &#123; $gt: 4 &#125; &#125;,</span><br><span class="line">  &#123; $set: &#123; test5: 'OK' &#125; &#125;,</span><br><span class="line">  true,</span><br><span class="line">  false</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>全部更新：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.collection.update(</span><br><span class="line">  &#123; count: &#123; $gt: 4 &#125; &#125;,</span><br><span class="line">  &#123; $set: &#123; test5: 'OK' &#125; &#125;,</span><br><span class="line">  true,</span><br><span class="line">  false</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>只更新第一条记录：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.collection.update(</span><br><span class="line">  &#123; count: &#123; $gt: 4 &#125; &#125;,</span><br><span class="line">  &#123; $set: &#123; test5: 'OK' &#125; &#125;,</span><br><span class="line">  true,</span><br><span class="line">  false</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="删除文档操作"><a class="markdownIt-Anchor" href="#删除文档操作"></a> 删除文档操作</h3>
<p>官方推荐使用 deleteOne() 和 deleteMany() 方法删除数据。</p>
<p>删除 status 等于 A 的全部文档：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.collection.deleteMany(&#123; status: 'A' &#125;)</span><br></pre></td></tr></table></figure>
<p>删除 status 等于 D 的一个文档：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.collection.deleteOne(&#123; status: 'D' &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="索引操作"><a class="markdownIt-Anchor" href="#索引操作"></a> 索引操作</h3>
<p>索引通常能够极大的提高查询的效率，如果没有索引，MongoDB 在读取数据时必须扫描集合中的每个文件并选取那些符合查询条件的记录。</p>
<p>这种扫描全集合的查询效率是非常低的，特别在处理大量的数据时，查询可以要花费几十秒甚至几分钟，这对网站的性能是非常致命的。</p>
<p>索引是特殊的数据结构，索引存储在一个易于遍历读取的数据集合中，索引是对数据库表中一列或多列的值进行排序的一种结构。</p>
<p>MongoDB 使用 createIndex() 方法来创建索引。</p>
<p>createIndex()方法基本语法格式如下所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">db.collection.createIndex(keys, options)</span></span><br></pre></td></tr></table></figure>
<p>语法中 Key 值为你要创建的索引字段，1 为指定按升序创建索引，如果你想按降序来创建索引指定为 -1 即可。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">db.col.createIndex(&#123;<span class="string">"title"</span>:1&#125;)</span></span><br></pre></td></tr></table></figure>
<p>createIndex() 方法中你也可以设置使用多个字段创建索引（关系型数据库中称作复合索引）。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">db.col.createIndex(&#123;<span class="string">"title"</span>:1,<span class="string">"description"</span>:-1&#125;)</span></span><br></pre></td></tr></table></figure>
<p>createIndex() 接收可选参数，可选参数列表如下：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Parameter</th>
<th style="text-align:left">Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">background</td>
<td style="text-align:left">Boolean</td>
<td style="text-align:left">建索引过程会阻塞其它数据库操作，background 可指定以后台方式创建索引，即增加 “background” 可选参数。 “background” 默认值为<strong>false</strong>。</td>
</tr>
<tr>
<td style="text-align:left">unique</td>
<td style="text-align:left">Boolean</td>
<td style="text-align:left">建立的索引是否唯一。指定为 true 创建唯一索引。默认值为<strong>false</strong>.</td>
</tr>
<tr>
<td style="text-align:left">name</td>
<td style="text-align:left">string</td>
<td style="text-align:left">索引的名称。如果未指定，MongoDB 的通过连接索引的字段名和排序顺序生成一个索引名称。</td>
</tr>
<tr>
<td style="text-align:left"><s>dropDups</s></td>
<td style="text-align:left"><s>Boolean</s></td>
<td style="text-align:left"><s>**3.0+版本已废弃。**在建立唯一索引时是否删除重复记录,指定 true 创建唯一索引。默认值为 <strong>false</strong>。</s></td>
</tr>
<tr>
<td style="text-align:left">sparse</td>
<td style="text-align:left">Boolean</td>
<td style="text-align:left">对文档中不存在的字段数据不启用索引；这个参数需要特别注意，如果设置为 true 的话，在索引字段中不会查询出不包含对应字段的文档.。默认值为 <strong>false</strong>.</td>
</tr>
<tr>
<td style="text-align:left">expireAfterSeconds</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">指定一个以秒为单位的数值，完成 TTL 设定，设定集合的生存时间。</td>
</tr>
<tr>
<td style="text-align:left">v</td>
<td style="text-align:left">index version</td>
<td style="text-align:left">索引的版本号。默认的索引版本取决于 mongod 创建索引时运行的版本。</td>
</tr>
<tr>
<td style="text-align:left">weights</td>
<td style="text-align:left">document</td>
<td style="text-align:left">索引权重值，数值在 1 到 99,999 之间，表示该索引相对于其他索引字段的得分权重。</td>
</tr>
<tr>
<td style="text-align:left">default_language</td>
<td style="text-align:left">string</td>
<td style="text-align:left">对于文本索引，该参数决定了停用词及词干和词器的规则的列表。 默认为英语</td>
</tr>
<tr>
<td style="text-align:left">language_override</td>
<td style="text-align:left">string</td>
<td style="text-align:left">对于文本索引，该参数指定了包含在文档中的字段名，语言覆盖默认的 language，默认值为 language.</td>
</tr>
</tbody>
</table>
<h2 id="mongodb-聚合操作"><a class="markdownIt-Anchor" href="#mongodb-聚合操作"></a> MongoDB 聚合操作</h2>
<p>MongoDB 中聚合(aggregate)主要用于处理数据(诸如统计平均值,求和等)，并返回计算后的数据结果。有点类似 sql 语句中的 count(*)。</p>
<h3 id="管道"><a class="markdownIt-Anchor" href="#管道"></a> 管道</h3>
<p>整个聚合运算过程称为管道，它是由多个步骤组成，每个管道</p>
<ul>
<li>接受一系列文档（原始数据）；</li>
<li>每个步骤对这些文档进行一系列运算；</li>
<li>结果文档输出给下一个步骤；</li>
</ul>
<p>聚合操作的基本格式</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pipeline = [$stage1, $stage1, ..., $stageN];</span><br><span class="line"></span><br><span class="line">db.&lt;集合&gt;.aggregate(pipeline, &#123;options&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="聚合步骤"><a class="markdownIt-Anchor" href="#聚合步骤"></a> 聚合步骤</h3>
<table>
<thead>
<tr>
<th>步骤</th>
<th>作用</th>
<th>SQL 等价运算符</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$match</code></td>
<td>过滤</td>
<td>WHERE</td>
</tr>
<tr>
<td><code>$project</code></td>
<td>投影</td>
<td>AS</td>
</tr>
<tr>
<td><code>$sort</code></td>
<td>排序</td>
<td>ORDER BY</td>
</tr>
<tr>
<td><code>$group</code></td>
<td>分组</td>
<td>GROUP BY</td>
</tr>
<tr>
<td><code>$skip</code> / <code>$limit</code></td>
<td>结果限制</td>
<td>SKIP / LIMIT</td>
</tr>
<tr>
<td><code>$lookup</code></td>
<td>左外连接</td>
<td>LEFT OUTER JOIN</td>
</tr>
<tr>
<td><code>$unwind</code></td>
<td>展开数组</td>
<td>N/A</td>
</tr>
<tr>
<td><code>$graphLookup</code></td>
<td>图搜索</td>
<td>N/A</td>
</tr>
<tr>
<td><code>$facet</code> / <code>$bucket</code></td>
<td>分面搜索</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<p>【示例】</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> db.collection.insertMany([&#123;<span class="string">"title"</span>:<span class="string">"MongoDB Overview"</span>,<span class="string">"description"</span>:<span class="string">"MongoDB is no sql database"</span>,<span class="string">"by_user"</span>:<span class="string">"collection"</span>,<span class="string">"tagsr"</span>:[<span class="string">"mongodb"</span>,<span class="string">"database"</span>,<span class="string">"NoSQL"</span>],<span class="string">"likes"</span>:<span class="string">"100"</span>&#125;,&#123;<span class="string">"title"</span>:<span class="string">"NoSQL Overview"</span>,<span class="string">"description"</span>:<span class="string">"No sql database is very fast"</span>,<span class="string">"by_user"</span>:<span class="string">"collection"</span>,<span class="string">"tagsr"</span>:[<span class="string">"mongodb"</span>,<span class="string">"database"</span>,<span class="string">"NoSQL"</span>],<span class="string">"likes"</span>:<span class="string">"10"</span>&#125;,&#123;<span class="string">"title"</span>:<span class="string">"Neo4j Overview"</span>,<span class="string">"description"</span>:<span class="string">"Neo4j is no sql database"</span>,<span class="string">"by_user"</span>:<span class="string">"Neo4j"</span>,<span class="string">"tagsr"</span>:[<span class="string">"neo4j"</span>,<span class="string">"database"</span>,<span class="string">"NoSQL"</span>],<span class="string">"likes"</span>:<span class="string">"750"</span>&#125;])</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> db.collection.aggregate([&#123;<span class="variable">$group</span> : &#123;_id : <span class="string">"<span class="variable">$by_user</span>"</span>, num_tutorial : &#123;<span class="variable">$sum</span> : 1&#125;&#125;&#125;])</span></span><br><span class="line">&#123; "_id" : null, "num_tutorial" : 3 &#125;</span><br><span class="line">&#123; "_id" : "Neo4j", "num_tutorial" : 1 &#125;</span><br><span class="line">&#123; "_id" : "collection", "num_tutorial" : 2 &#125;</span><br></pre></td></tr></table></figure>
<p>下表展示了一些聚合的表达式:</p>
<table>
<thead>
<tr>
<th style="text-align:left">表达式</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">实例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>$sum</code></td>
<td style="text-align:left">计算总和。</td>
<td style="text-align:left"><code>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, num_tutorial : {$sum : &quot;$likes&quot;}}}])</code></td>
</tr>
<tr>
<td style="text-align:left"><code>$avg</code></td>
<td style="text-align:left">计算平均值</td>
<td style="text-align:left"><code>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, num_tutorial : {$avg : &quot;$likes&quot;}}}])</code></td>
</tr>
<tr>
<td style="text-align:left"><code>$min</code></td>
<td style="text-align:left">获取集合中所有文档对应值得最小值。</td>
<td style="text-align:left"><code>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, num_tutorial : {$min : &quot;$likes&quot;}}}])</code></td>
</tr>
<tr>
<td style="text-align:left"><code>$max</code></td>
<td style="text-align:left">获取集合中所有文档对应值得最大值。</td>
<td style="text-align:left"><code>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, num_tutorial : {$max : &quot;$likes&quot;}}}])</code></td>
</tr>
<tr>
<td style="text-align:left"><code>$push</code></td>
<td style="text-align:left">在结果文档中插入值到一个数组中。</td>
<td style="text-align:left"><code>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, url : {$push: &quot;$url&quot;}}}])</code></td>
</tr>
<tr>
<td style="text-align:left"><code>$addToSet</code></td>
<td style="text-align:left">在结果文档中插入值到一个数组中，但不创建副本。</td>
<td style="text-align:left"><code>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, url : {$addToSet : &quot;$url&quot;}}}])</code></td>
</tr>
<tr>
<td style="text-align:left"><code>$first</code></td>
<td style="text-align:left">根据资源文档的排序获取第一个文档数据。</td>
<td style="text-align:left"><code>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, first_url : {$first : &quot;$url&quot;}}}])</code></td>
</tr>
<tr>
<td style="text-align:left"><code>$last</code></td>
<td style="text-align:left">根据资源文档的排序获取最后一个文档数据</td>
<td style="text-align:left"><code>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, last_url : {$last : &quot;$url&quot;}}}])</code></td>
</tr>
</tbody>
</table>
<h2 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h2>
<ul>
<li><a href="https://www.mongodb.com/" target="_blank" rel="noopener">MongoDB 官网</a></li>
<li><a href="https://github.com/mongodb/mongo" target="_blank" rel="noopener">MongoDB Github</a></li>
<li><a href="https://www.runoob.com/mongodb/mongodb-tutorial.html" target="_blank" rel="noopener">MongoDB 教程</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/2020/08/13/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020/08/13/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">错误处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-13 23:32:37" itemprop="dateCreated datePublished" datetime="2020-08-13T23:32:37+08:00">2020-08-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-14 16:45:53" itemprop="dateModified" datetime="2022-04-14T16:45:53+08:00">2022-04-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index">
                    <span itemprop="name">设计</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E8%AE%BE%E8%AE%A1/%E7%BC%96%E7%A8%8B%E8%8C%83%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">编程范式</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2020/08/13/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/08/13/错误处理/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="错误处理"><a class="markdownIt-Anchor" href="#错误处理"></a> 错误处理</h1>
<h2 id="错误的分类"><a class="markdownIt-Anchor" href="#错误的分类"></a> 错误的分类</h2>
<h4 id="资源的错误"><a class="markdownIt-Anchor" href="#资源的错误"></a> 资源的错误</h4>
<p>当我们的代码去请求一些资源时导致的错误，比如打开一个没有权限的文件，写文件时出现的写错误，发送文件到网络端发现网络故障的错误，等等。<strong>这一类错误属于程序运行环境的问题。对于这类错误，有的我们可以处理，有的我们则无法处理。比如，内存耗尽、栈溢出或是一些程序运行时关键性资源不能满足等等这些情况，我们只能停止运行，甚至退出整个程序。</strong></p>
<h4 id="程序的错误"><a class="markdownIt-Anchor" href="#程序的错误"></a> 程序的错误</h4>
<p>比如：空指针、非法参数等。<strong>这类是我们自己程序的错误，我们要记录下来，写入日志，最好触发监控系统报警</strong>。</p>
<h4 id="用户的错误"><a class="markdownIt-Anchor" href="#用户的错误"></a> 用户的错误</h4>
<p>比如：Bad Request、Bad Format 等这类由用户不合法输入带来的错误。<strong>这类错误基本上是在用户的 API 层上出现的问题</strong>。比如，解析一个 XML 或 JSON 文件，或是用户输入的字段不合法之类的。</p>
<p><strong>对于这类问题，我们需要向用户端报错，让用户自己处理修正他们的输入或操作。然后，我们正常执行，但是需要做统计，统计相应的错误率，这样有利于我们改善软件或是侦测是否有恶意的用户请求。</strong></p>
<h2 id="错误返回码和异常捕捉"><a class="markdownIt-Anchor" href="#错误返回码和异常捕捉"></a> 错误返回码和异常捕捉</h2>
<p>错误处理一般有两种方式：错误返回码和异常捕捉。</p>
<ul>
<li>对于我们并不期望会发生的事，我们可以使用异常捕捉；</li>
<li>对于我们觉得可能会发生的事，使用返回码。</li>
</ul>
<h2 id="异步编程的错误处理"><a class="markdownIt-Anchor" href="#异步编程的错误处理"></a> 异步编程的错误处理</h2>
<ul>
<li><strong>无法使用返回码</strong>。因为函数在“被”异步运行中，所谓的返回只是把处理权交给下一条指令，而不是把函数运行完的结果返回。<strong>所以，函数返回的语义完全变了，返回码也没有用了</strong>。</li>
<li><strong>无法使用抛异常的方式</strong>。因为除了上述的函数立马返回的原因之外，抛出的异常也在另外一个线程中，不同线程中的栈是完全不一样的，所以主线程的 <code>catch</code> 完全看不到另外一个线程中的异常。</li>
</ul>
<h3 id="callback-错误处理"><a class="markdownIt-Anchor" href="#callback-错误处理"></a> callback 错误处理</h3>
<p>异步编程中，最常用的错误处理方式就是 <code>callback</code>方式。在做异步请求的时候，注册几个 <code>OnSuccess()</code>、 <code>OnFailure()</code> 这样的函数，让在另一个线程中运行的异步代码来回调过来。</p>
<p>【示例】JavaScript 异步编程的错误处理</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">successCallback</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'It succeeded with '</span> + result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">failureCallback</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'It failed with '</span> + error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">doSomething(successCallback, failureCallback)</span><br></pre></td></tr></table></figure>
<p>但是， 如果我们需要把几个异步函数顺序执行的话（异步程序中，程序执行的顺序是不可预测的、也是不确定的，而有时候，函数被调用的上下文是有相互依赖的，所以，我们希望它们能按一定的顺序处理），就会出现了所谓的 Callback Hell 的问题。如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">doSomething(<span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">  doSomethingElse(</span><br><span class="line">    result,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">newResult</span>) </span>&#123;</span><br><span class="line">      doThirdThing(</span><br><span class="line">        newResult,</span><br><span class="line">        <span class="function"><span class="keyword">function</span> (<span class="params">finalResult</span>) </span>&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'Got the final result: '</span> + finalResult)</span><br><span class="line">        &#125;,</span><br><span class="line">        failureCallback</span><br><span class="line">      )</span><br><span class="line">    &#125;,</span><br><span class="line">    failureCallback</span><br><span class="line">  )</span><br><span class="line">&#125;, failureCallback)</span><br></pre></td></tr></table></figure>
<p>而这样层层嵌套中需要注册的错误处理函数也有可能是完全不一样的，而且会导致代码非常混乱，难以阅读和维护。</p>
<h3 id="javascript-的-promise-错误处理"><a class="markdownIt-Anchor" href="#javascript-的-promise-错误处理"></a> JavaScript 的 Promise 错误处理</h3>
<p>在异步编程的实践里，使用 Promise 模式来处理更为优雅。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">doSomething()</span><br><span class="line">.then(<span class="function"><span class="params">result</span> =&gt;</span> doSomethingElse(result))</span><br><span class="line">.then(<span class="function"><span class="params">newResult</span> =&gt;</span> doThirdThing(newResult))</span><br><span class="line">.then(<span class="function"><span class="params">finalResult</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Got the final result: <span class="subst">$&#123;finalResult&#125;</span>`</span>);</span><br><span class="line">&#125;).catch(failureCallback);</span><br></pre></td></tr></table></figure>
<p>上面代码中的 <code>then()</code> 和 <code>catch()</code> 方法就是 Promise 对象的方法，<code>then()</code>方法可以把各个异步的函数给串联起来，而<code>catch()</code> 方法则是出错的处理。</p>
<p>看到上面的那个级联式的调用方式，这就要我们的 <code>doSomething()</code> 函数返回 Promise 对象，下面是这个函数的相关代码示例：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSomething</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>();</span><br><span class="line">	<span class="keyword">let</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">	xhr.open(<span class="string">'GET'</span>, <span class="string">'http://coolshell.cn/....'</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">	xhr.onload = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.status === <span class="number">200</span>) &#123;</span><br><span class="line">            results = <span class="built_in">JSON</span>.parse(<span class="keyword">this</span>.responseText);</span><br><span class="line">            promise.resolve(results); <span class="comment">// 成功时，调用 resolve() 方法</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    xhr.onerror = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">        promise.reject(e); <span class="comment">// 失败时，调用 reject() 方法</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    xhr.send();</span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的代码示例中，我们可以看到，如果成功了，要调用<br />
<code>Promise.resolve()</code> 方法，这样 Promise 对象会继续调用下一个 <code>then()</code>。如果出错了就调用 <code>Promise.reject()</code> 方法，这样就会忽略后面的 <code>then()</code> 直到 <code>catch()</code> 方法。</p>
<p>我们可以看到 <code>Promise.reject()</code> 就像是抛异常一样。这个编程模式让我们的代码组织方便了很多。</p>
<p>另外，多说一句，Promise 还可以同时等待两个不同的异步方法。比如下面的代码所展示的方式：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">promise1 = doSomething();</span><br><span class="line">promise2 = doSomethingElse();</span><br><span class="line"><span class="built_in">Promise</span>.when(promise1, promise2).then( <span class="function"><span class="keyword">function</span> (<span class="params">result1, result2</span>) </span>&#123;</span><br><span class="line">	... <span class="comment">// 处理 result1 和 result2 的代码</span></span><br><span class="line">&#125;, handleError);</span><br></pre></td></tr></table></figure>
<p>在 ECMAScript 2017 的标准中，我们可以使用<code>async</code>/<code>await</code> 这两个关键字来取代 Promise 对象，这样可以让我们的代码更易读。</p>
<p>比如下面的代码示例：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> result = <span class="keyword">await</span> doSomething();</span><br><span class="line">    <span class="keyword">let</span> newResult = <span class="keyword">await</span> doSomethingElse(result);</span><br><span class="line">    <span class="keyword">let</span> finalResult = <span class="keyword">await</span> doThirdThing(newResult);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Got the final result: <span class="subst">$&#123;finalResult&#125;</span>`</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span>(error) &#123;</span><br><span class="line">    failureCallback(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果在函数定义之前使用了 <code>async</code> 关键字，就可以在函数内使用 <code>await</code>。 当在 <code>await</code> 某个 <code>Promise</code> 时，函数暂停执行，直至该 <code>Promise</code> 产生结果，并且暂停不会阻塞主线程。 如果 <code>Promise</code> resolve，则会返回值。 如果 <code>Promise</code> reject，则会抛出拒绝的值。</p>
<h3 id="java-的-promise-模式"><a class="markdownIt-Anchor" href="#java-的-promise-模式"></a> Java 的 Promise 模式</h3>
<p>在 JDK 1.8 里也引入了类似 JavaScript 的玩法 —— <code>CompletableFuture</code>。这个类提供了大量的异步编程中 Promise 的各种方式。</p>
<p>链式处理：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CompletableFuture.supplyAsync(<span class="keyword">this</span>::findReceiver)</span><br><span class="line">                 .thenApply(<span class="keyword">this</span>::sendMsg)</span><br><span class="line">                 .thenAccept(<span class="keyword">this</span>::notify);</span><br></pre></td></tr></table></figure>
<p>上面的这个链式处理和 JavaScript 中的<code>then()</code>方法很像，其中的<br />
<code>supplyAsync()</code> 表示执行一个异步方法，而 <code>thenApply()</code> 表示执行成功后再串联另外一个异步方法，最后是 <code>thenAccept()</code> 来处理最终结果。</p>
<p>下面这个例子是要合并两个异步函数的结果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String result = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">     &#125;).thenCombine(CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">"world"</span>;</span><br><span class="line">     &#125;), (s1, s2) -&gt; s1 + <span class="string">" "</span> + s2).join());</span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure>
<p>接下来，我们再来看一下，Java 这个类相关的异常处理：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CompletableFuture.supplyAsync(Integer::parseInt) <span class="comment">// 输入: "ILLEGAL"</span></span><br><span class="line">			     .thenApply(r -&gt; r * <span class="number">2</span> * Math.PI)</span><br><span class="line">			     .thenApply(s -&gt; <span class="string">"apply&gt;&gt; "</span> + s)</span><br><span class="line">			     .exceptionally(ex -&gt; <span class="string">"Error: "</span> + ex.getMessage());</span><br></pre></td></tr></table></figure>
<p>我们要注意到上面代码里的 <code>exceptionally()</code> 方法，这个和 JavaScript Promise 中的 <code>catch()</code> 方法相似。</p>
<p>运行上面的代码，会出现如下输出：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Error: java.lang.NumberFormatException: For input string: <span class="string">"ILLEGAL"</span></span><br></pre></td></tr></table></figure>
<p>也可以这样：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CompletableFuture.supplyAsync(Integer::parseInt) <span class="comment">// 输入: "ILLEGAL"</span></span><br><span class="line">				 .thenApply(r -&gt; r * <span class="number">2</span> * Math.PI)</span><br><span class="line">				 .thenApply(s -&gt; <span class="string">"apply&gt;&gt; "</span> + s)</span><br><span class="line">				 .handle((result, ex) -&gt; &#123;</span><br><span class="line">				 	<span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">				 		<span class="keyword">return</span> result;</span><br><span class="line">				 	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				 		<span class="keyword">return</span> <span class="string">"Error handling: "</span> + ex.getMessage();</span><br><span class="line">				 	&#125;</span><br><span class="line">				 &#125;);</span><br></pre></td></tr></table></figure>
<p>上面代码中，你可以看到，其使用了 <code>handle()</code> 方法来处理最终的结果，其中包含了异步函数中的错误处理。</p>
<h2 id="错误处理的最佳实践"><a class="markdownIt-Anchor" href="#错误处理的最佳实践"></a> 错误处理的最佳实践</h2>
<ul>
<li><strong>统一分类的错误字典</strong>。无论你是使用错误码还是异常捕捉，都需要认真并统一地做好错误的分类。最好是在一个地方定义相关的错误。比如，HTTP 的 4XX 表示客户端有问题，5XX 则表示服务端有问题。也就是说，你要建立一个错误字典。</li>
<li><strong>同类错误的定义最好是可以扩展的</strong>。这一点非常重要，而对于这一点，通过面向对象的继承或是像 Go 语言那样的接口多态可以很好地做到。这样可以方便地重用已有的代码。</li>
<li><strong>定义错误的严重程度</strong>。比如，Fatal 表示重大错误，Error 表示资源或需求得不到满足，Warning 表示并不一定是个错误但还是需要引起注意，Info 表示不是错误只是一个信息，Debug 表示这是给内部开发人员用于调试程序的。</li>
<li><strong>错误日志的输出最好使用错误码，而不是错误信息</strong>。打印错误日志的时候，应该使用统一的格式。但最好不要用错误信息，而应使用相应的错误码，错误码不一定是数字，也可以是一个能从错误字典里找到的一个唯一的可以让人读懂的关键字。这样，会非常有利于日志分析软件进行自动化监控，而不是要从错误信息中做语义分析。比如：HTTP 的日志中就会有 HTTP 的返回码，如：<code>404</code>。但我更推荐使用像<code>PageNotFound</code>这样的标识，这样人和机器都很容易处理。</li>
<li><strong>忽略错误最好有日志</strong>。不然会给维护带来很大的麻烦。</li>
<li><strong>对于同一个地方不停的报错，最好不要都打到日志里</strong>。不然这样会导致其它日志被淹没了，也会导致日志文件太大。最好的实践是，打出一个错误以及出现的次数。</li>
<li><strong>不要用错误处理逻辑来处理业务逻辑</strong>。也就是说，不要使用异常捕捉这样的方式来处理业务逻辑，而是应该用条件判断。如果一个逻辑控制可以用 if - else 清楚地表达，那就不建议使用异常方式处理。异常捕捉是用来处理不期望发生的事情，而错误码则用来处理可能会发生的事。</li>
<li><strong>对于同类的错误处理，用一样的模式</strong>。比如，对于<code>null</code>对象的错误，要么都用返回 null，加上条件检查的模式，要么都用抛 NullPointerException 的方式处理。不要混用，这样有助于代码规范。</li>
<li><strong>尽可能在错误发生的地方处理错误</strong>。因为这样会让调用者变得更简单。</li>
<li><strong>向上尽可能地返回原始的错误</strong>。如果一定要把错误返回到更高层去处理，那么，应该返回原始的错误，而不是重新发明一个错误。</li>
<li><strong>处理错误时，总是要清理已分配的资源</strong>。这点非常关键，使用 RAII 技术，或是 try-catch-finally，或是 Go 的 defer 都可以容易地做到。</li>
<li><strong>不推荐在循环体里处理错误</strong>。这里说的是 try-catch，绝大多数的情况你不需要这样做。最好把整个循环体外放在 try 语句块内，而在外面做 catch。</li>
<li><strong>不要把大量的代码都放在一个 try 语句块内</strong>。一个 try 语句块内的语句应该是完成一个简单单一的事情。</li>
<li><strong>为你的错误定义提供清楚的文档以及每种错误的代码示例</strong>。如果你是做 RESTful API 方面的，使用 Swagger 会帮你很容易搞定这个事。</li>
<li><strong>对于异步的方式，推荐使用 Promise 模式处理错误</strong>。对于这一点，JavaScript 中有很好的实践。</li>
<li><strong>对于分布式的系统，推荐使用 APM 相关的软件</strong>。尤其是使用 Zipkin 这样的服务调用跟踪的分析来关联错误。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/5/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/blog/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/18/">18</a><a class="extend next" rel="next" href="/blog/page/7/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Zhang Peng"
    src="/blog/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Zhang Peng</p>
  <div class="site-description" itemprop="description">Dunwu's Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">173</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">102</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/dunwu" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;dunwu" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:forbreak@163.com" title="E-Mail &amp;rarr; mailto:forbreak@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/blog/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-paper-plane"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhang Peng</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">976k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">14:48</span>
</div>

        












        
      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-nest@1/canvas-nest.min.js"></script>
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/pisces.js"></script>


<script src="/blog/js/next-boot.js"></script>

<script src="/blog/js/bookmark.js"></script>




  




  
<script src="/blog/js/local-search.js"></script>














  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://blog-ajay4qmfci.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
